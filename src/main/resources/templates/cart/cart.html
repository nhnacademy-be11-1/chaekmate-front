<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<head>
    <title>장바구니</title>
</head>

<section>
    <!-- Breadcrumb Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="#">Home</a>
                    <a class="breadcrumb-item text-dark" href="#">Shop</a>
                    <span class="breadcrumb-item active">Shopping Cart</span>
                </nav>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Cart Start -->
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-8 table-responsive mb-5">
                <table class="table table-light table-borderless table-hover text-center mb-0" id="cartTable">
                    <thead class="thead-dark">
                    <tr>
                        <th>Products</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Remove</th>
                    </tr>
                    </thead>
                    <!-- 장바구니에 아이템이 있을 때 -->
                    <tbody class="align-middle" th:if="${cart != null and cart.items != null and !#lists.isEmpty(cart.items)}">
                    <tr th:each="item : ${cart.items}" class="cart-item"
                        th:attr="data-book-id=${item.bookId},
                                 data-price=${item.bookSalesPrice},
                                 data-quantity=${item.quantity}">
                        <td class="align-middle">
                            <img th:src="${item.bookImageUrl}" alt="" style="width: 50px;">
                            <span th:text="${item.bookTitle}">Product Name</span>
                        </td>
                        <td class="align-middle">
                            <div class="d-flex flex-column align-items-center">
                                <span class="item-price" th:text="${#numbers.formatInteger(item.bookSalesPrice, 1, 'COMMA')} + '원'">17,500원</span>
                                <small class="text-muted discount-rate" style="font-size: 0.85em;"></small>
                            </div>
                        </td>
                        <td class="align-middle">
                            <div class="input-group quantity mx-auto" style="width: 100px;">
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-primary btn-minus"
                                            th:attr="data-book-id=${item.bookId}">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-sm bg-secondary border-0 text-center item-quantity"
                                       th:value="${item.quantity}" readonly>
                                <div class="input-group-btn">
                                    <button class="btn btn-sm btn-primary btn-plus"
                                            th:attr="data-book-id=${item.bookId}">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="align-middle item-total" th:text="${#numbers.formatInteger(item.bookSalesPrice * item.quantity, 1, 'COMMA')} + '원'">0원</td>
                        <td class="align-middle">
                            <button class="btn btn-sm btn-danger btn-remove" th:attr="data-book-id=${item.bookId}">
                                <i class="fa fa-times"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                    <!-- 장바구니가 비어있을 때 -->
                    <tbody th:if="${cart == null or cart.items == null or #lists.isEmpty(cart.items) or cart.cartId == null}">
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <p class="mb-0">장바구니가 비어 있습니다.</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-lg-4">
                <form class="mb-30" action="">
                    <div class="input-group">
                        <input type="text" class="form-control border-0 p-4" placeholder="Coupon Code">
                        <div class="input-group-append">
                            <button class="btn btn-primary">Apply Coupon</button>
                        </div>
                    </div>
                </form>
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">Cart Summary</span>
                </h5>
                <div class="bg-light p-30 mb-5">
                    <!-- 장바구니에 아이템이 있을 때만 요약 정보 표시 -->
                    <div id="cartSummary" th:if="${cart != null and cart.items != null and !#lists.isEmpty(cart.items)}">
                        <div class="border-bottom pb-2">
                            <div class="d-flex justify-content-between mb-3">
                                <h6>Subtotal</h6>
                                <h6 id="subtotal">0원</h6>
                            </div>
                            <div class="d-flex justify-content-between">
                                <h6 class="font-weight-medium">Shipping</h6>
                                <h6 class="font-weight-medium" id="shipping">10원</h6>
                            </div>
                        </div>
                        <div class="pt-2">
                            <div class="d-flex justify-content-between mt-2">
                                <h5>Total</h5>
                                <h5 id="total">0원</h5>
                            </div>
                            <button class="btn btn-block btn-primary font-weight-bold my-3 py-3">Proceed To Checkout</button>
                        </div>
                    </div>
                    <!-- 장바구니가 비어있을 때 -->
                    <div id="emptyCart" th:if="${cart == null or cart.items == null or #lists.isEmpty(cart.items)}">
                        <div class="text-center py-3">
                            <p class="mb-0">장바구니에 담긴 상품이 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Cart End -->

    <script th:inline="javascript">
        // 숫자 포맷팅 함수 (천단위 콤마)
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "원";
        }

        // 장바구니 총합 계산 함수
        function calculateCartTotal() {
            const cartItems = document.querySelectorAll('.cart-item');
            let subtotal = 0;

            cartItems.forEach(item => {
                const price = parseInt(item.getAttribute('data-price'));
                const quantity = parseInt(item.getAttribute('data-quantity'));
                subtotal += price * quantity;
            });

            const shipping = 10;
            const total = subtotal + shipping;

            // DOM 업데이트
            const subtotalElement = document.getElementById('subtotal');
            const totalElement = document.getElementById('total');

            if (subtotalElement) {
                subtotalElement.textContent = formatNumber(subtotal);
            }
            if (totalElement) {
                totalElement.textContent = formatNumber(total);
            }
        }

        // 개별 아이템 총액 업데이트 함수
        function updateItemTotal(row) {
            const price = parseInt(row.getAttribute('data-price'));
            const quantity = parseInt(row.getAttribute('data-quantity'));
            const total = price * quantity;

            const totalElement = row.querySelector('.item-total');
            if (totalElement) {
                totalElement.textContent = formatNumber(total);
            }
        }

        // 수량 증가 버튼 이벤트
        document.querySelectorAll('.btn-plus').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                const row = document.querySelector(`.cart-item[data-book-id="${bookId}"]`);
                const quantityInput = row.querySelector('.item-quantity');

                let quantity = parseInt(row.getAttribute('data-quantity'));
                quantity += 1;

                row.setAttribute('data-quantity', quantity);
                quantityInput.value = quantity;

                updateItemTotal(row);
                calculateCartTotal();

                // TODO: 서버에 수량 업데이트 API 호출
                // updateCartItemQuantity(bookId, quantity);
            });
        });

        // 수량 감소 버튼 이벤트
        document.querySelectorAll('.btn-minus').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');
                const row = document.querySelector(`.cart-item[data-book-id="${bookId}"]`);
                const quantityInput = row.querySelector('.item-quantity');

                let quantity = parseInt(row.getAttribute('data-quantity'));

                if (quantity > 1) {
                    quantity -= 1;

                    row.setAttribute('data-quantity', quantity);
                    quantityInput.value = quantity;

                    updateItemTotal(row);
                    calculateCartTotal();

                    // TODO: 서버에 수량 업데이트 API 호출
                    // updateCartItemQuantity(bookId, quantity);
                }
            });
        });

        // 아이템 삭제 버튼 이벤트
        document.querySelectorAll('.btn-remove').forEach(button => {
            button.addEventListener('click', function() {
                const bookId = this.getAttribute('data-book-id');

                if (confirm('이 상품을 장바구니에서 삭제하시겠습니까?')) {
                    // TODO: 서버에 삭제 API 호출
                    // deleteCartItem(bookId);

                    // 임시: DOM에서 제거
                    const row = document.querySelector(`.cart-item[data-book-id="${bookId}"]`);
                    row.remove();

                    calculateCartTotal();

                    // 장바구니가 비었는지 확인
                    if (document.querySelectorAll('.cart-item').length === 0) {
                        location.reload(); // 페이지 새로고침
                    }
                }
            });
        });

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            calculateCartTotal();   // 총합 계산
        });
    </script>
</section>
</html>