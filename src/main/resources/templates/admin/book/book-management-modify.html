<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/layout/admin-layout :: html(~{::section})}">
<section>
    <!-- 날짜선택기 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- TOAST UI CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />


    <div class="container-fluid" th:with="bookId=${book.id}">
        <div class="row px-xl-5">
            <div class="col-12">
                <h2 class="h2 font-weight-bold text-dark mb-4" th:text="${book.title} + ' 정보 수정'">도서 정보 수정</h2>
                <!-- Main Form for Everything -->

                <form th:action="@{/admin/books/{id}/modify(id=${book.id})}" method="post">
                    <input type="hidden" name="_method" value="put"/>
                    <input type="hidden" name="id" th:value="${book.id}" />
                    <input type="hidden" name="views" th:value="${book.views}" />

                    <!-- Thumbnail Management Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">썸네일 관리</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <h6>현재 썸네일</h6>
                                    <img id="thumbnail-preview" th:src="${thumbnail != null ? thumbnail.imageUrl() : '/img/no-image.jpeg'}"
                                         class="img-fluid rounded" alt="Thumbnail Preview" style="max-height: 250px;">
                                </div>
                                <div class="col-md-9">
                                    <div class="form-group">
                                        <label for="thumbnail-upload-input">새 썸네일 파일 선택</label>
                                        <input type="file" class="form-control-file" id="thumbnail-upload-input" accept="image/*">
                                        <small id="thumbnail-status" class="form-text"></small>
                                        <!-- Hidden input to store the new thumbnail URL -->
                                        <input type="hidden" id="new-thumbnail-url" name="newThumbnailUrl">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detail Image Management Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">상세 이미지 관리</h5>
                        </div>
                        <div class="card-body">
                            <h6>현재 상세 이미지</h6>
                            <div id="detail-images-container" class="row mb-3">
                                <div th:each="image : ${detailImages}" class="col-md-3 mb-3" th:id="'detail-image-container-' + ${image.bookImageId()}">
                                    <div class="position-relative">
                                        <img th:src="${image.imageUrl()}" class="img-fluid rounded" alt="Detail">
                                        <button type="button" class="btn btn-sm btn-danger position-absolute delete-detail-btn"
                                                style="top: 5px; right: 5px;" th:attr="data-image-id=${image.bookImageId()}">
                                            &times;
                                        </button>
                                    </div>
                                </div>
                                <div th:if="${#lists.isEmpty(detailImages)}" class="col-12">
                                    <p class="text-muted">등록된 상세 이미지가 없습니다.</p>
                                </div>
                            </div>
                            <hr>
                            <h6 class="mb-1">새 이미지 추가</h6>
                            <small class="text-muted">이미지가 없으면 처음 추가된 이미지가 썸네일이 됩니다</small>
                            <div class="form-group mt-3">
                                <label for="detail-image-upload-input">추가할 이미지 파일 선택</label>
                                <input type="file" class="form-control-file" id="detail-image-upload-input" accept="image/*">
                                <small id="detail-image-status" class="form-text"></small>
                            </div>
                            <!-- Container for newly added image previews and their hidden inputs -->
                            <div id="new-detail-images-preview-container" class="row mt-3"></div>
                        </div>
                    </div>

                    <!-- Main Book Info Form Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">도서 정보</h5>
                        </div>
                        <div class="card-body">
                            <!-- Hidden fields for image changes -->
                            <input type="hidden" id="deleted-image-ids" name="deletedImageIds">
                            <div id="new-detail-urls-container"></div>

                            <!-- Text-based fields for the book -->
                            <div class="form-group">
                                <label for="title">제목</label>
                                <input type="text" id="title" name="title" class="form-control" th:value="${book.title}">
                            </div>
                            <div class="form-group">
                                <label for="author">저자</label>
                                <input type="text" id="author" name="author" class="form-control" th:value="${book.author}">
                            </div>
                            <div class="form-group">
                                <label for="publisher">출판사</label>
                                <input type="text" id="publisher" name="publisher" class="form-control" th:value="${book.publisher}">
                            </div>
                            <div class="form-group">
                                <label for="isbn">ISBN</label>
                                <input type="text" id="isbn" name="isbn" class="form-control" th:value="${book.isbn}">
                            </div>
                            <div class="form-group">
                                <label for="publishedAt">출판일</label>
                                <input type="text" id="publishedAt" name="publishedAt" class="form-control datetime-picker" th:value="${book.publishedAt}">
                            </div>
                            <div class="form-group">
                                <label for="price">정가</label>
                                <input type="number" id="price" name="price" class="form-control" th:value="${book.price}">
                            </div>
                            <div class="form-group">
                                <label for="salesPrice">판매가</label>
                                <input type="number" id="salesPrice" name="salesPrice" class="form-control" th:value="${book.salesPrice}">
                            </div>
                            <div class="form-group">
                                <label for="stock">재고</label>
                                <input type="number" id="stock" name="stock" class="form-control" th:value="${book.stock}">
                            </div>
                            <div class="form-group">
                                <label for="index">목차</label>
                                <div id ="index-editor"></div>
                                <input type="hidden" id="index" name="index" th:value="*{book.index}" />
                            </div>
                            <div class="form-group">
                                <label for="description">설명</label>
                                <div id="description-editor"></div>
                                <input type="hidden" id="description" name="description" th:value="*{book.description}" />
                            </div>
                            <div class="form-check">
                                <input type="checkbox" id="isWrappable" name="isWrappable" class="form-check-input" th:field="${book.isWrappable}">
                                <label class="form-check-label" for="isWrappable">포장 가능</label>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" id="isSaleEnd" name="isSaleEnd" class="form-check-input" th:field="${book.isSaleEnd}">
                                <label class="form-check-label" for="isSaleEnd">판매 종료</label>
                            </div>
                            <div class="form-group">
                                <label for="categoryIds">카테고리</label>
                                <div class="border p-2 mb-2 bg-light">
                                    <strong>선택된 카테고리:</strong>
                                    <span id="selected-category-names" th:text="${#strings.isEmpty(book.categoryNames)} ? '없음' : ${#strings.listJoin(book.categoryNames, ', ')}">없음</span>
                                </div>
                                <input type="hidden" id="categoryIds" name="categoryIds" th:value="${#strings.listJoin(book.categoryIds, ',')}">
                                <div id="category-tree-container" class="category-selector border p-3" style="max-height: 400px; overflow-y: auto;" th:attr="data-initial-ids=${#strings.listJoin(book.categoryIds, ',')}, data-initial-names=${#strings.listJoin(book.categoryNames, ',')}">
                                    <div th:replace="~{fragments/category-tree :: categoryTree(categories=${categories})}"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tagIds">태그</label>
                                <div class="border p-2 mb-2 bg-light">
                                    <strong>선택된 태그:</strong>
                                    <span id="selected-tag-names" th:text="${#strings.isEmpty(book.tagNames)} ? '없음' : ${#strings.listJoin(book.tagNames, ', ')}">없음</span>
                                </div>
                                <input type="hidden" id="tagIds" name="tagIds" th:value="${#strings.listJoin(book.tagIds, ',')}">
                                <div id="tag-tree-container" class="tag-selector border p-3" style="max-height: 400px; overflow-y: auto;" th:attr="data-initial-ids=${#strings.listJoin(book.tagIds, ',')}, data-initial-names=${#strings.listJoin(book.tagNames, ',')}">
                                    <div th:replace="~{fragments/tag-tree :: tagTree(tags=${tags})}"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a th:href="@{/admin/books}" class="btn btn-secondary">취소</a>
                            <button type="submit" class="btn btn-primary">모든 변경사항 저장</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script th:src="@{/js/image-upload.js}"></script>

    <!-- 날짜 선택기 -->
    <script th:src="@{/js/admin-date-selector.js}"></script>


    <!-- Toast UI (WYSIWYG) -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

</section>
</html>
