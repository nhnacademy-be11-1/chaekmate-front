<!-- src/main/resources/templates/member/mypage.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<section>
    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-10 mb-5 mx-auto">
                <div class="bg-light p-30">
                    <h2 class="mb-4">마이페이지</h2>

                    <!-- 시스템 메시지 -->
                    <div th:if="${msg != null}" class="alert alert-success" th:text="${msg}">처리되었습니다.</div>

                    <!-- 등급 -->
                    <div class="mb-4">
                        <h4 class="mb-3">내 등급</h4>
                        <div class="p-3 border rounded bg-white">
                            <p class="mb-1"><strong>등급:</strong> <span th:text="${grade != null ? grade.name() : 'N/A'}">N/A</span></p>
                            <p class="mb-1"><strong>포인트 적립률:</strong> <span th:text="${grade != null ? grade.pointRate()+'%' : 0}">0</span></p>
                        </div>
                    </div>

                    <!-- 주소 목록 -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4 class="mb-0">배송지</h4>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                            주소 추가
                        </button>
                    </div>
                    <div class="list-group mb-4" id="addressList" th:if="${addresses != null}">
                        <div class="list-group-item d-flex justify-content-between align-items-center"
                             th:each="addr : ${addresses}">
                            <div>
                                <span class="badge bg-success me-2" th:if="${addr.main}">기본</span>
                                <span th:text="${addr.streetName}">세종대로 110</span>
                                <span class="text-muted ms-1" th:text="${'(' + addr.zipcode + ')'}">(06236)</span>
                                <div class="small text-muted" th:text="${addr.detail}">상세</div>
                                <div class="small text-muted" th:text="${addr.memo}">메모</div>
                            </div>
                            <div class="d-flex gap-2">
                                <form th:action="@{'/mypage/address/' + ${addr.id} + '/main'}" th:if="${!addr.main}" method="post" class="d-inline">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-outline-secondary btn-sm">기본 지정</button>
                                </form>
                                <form th:action="@{'/mypage/address/' + ${addr.id}}" method="post" class="d-inline"
                                      onsubmit="return confirm('삭제하시겠습니까?');">
                                    <input type="hidden" name="_method" value="delete"/>
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-outline-danger btn-sm">삭제</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 탈퇴 (페이지 맨 아래) -->
                    <div class="p-3 border rounded bg-white">
                        <p class="mb-3">탈퇴 시 계정이 비활성화(또는 삭제)되며 복구가 불가할 수 있습니다.</p>
                        <form method="post" th:action="@{/mypage/withdraw}" onsubmit="return confirm('정말 탈퇴하시겠습니까?');">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-outline-danger">회원 탈퇴</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 주소 추가 모달 -->
    <!--/*@thymesVar id="createAddressRequest" type="shop.chaekmate.front.member.dto.request.CreateAddressRequest"*/-->
    <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="addressForm" method="post" th:action="@{/mypage/address}" th:object="${createAddressRequest}" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="addressModalLabel">주소 추가</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                    </div>
                    <div class="modal-body">

                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <!-- 도로명 검색 -->
                        <div class="mb-3">
                            <label class="form-label">도로명 주소</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="roadAddress" placeholder="카카오 버튼으로 검색" readonly required>
                                <button type="button" class="btn btn-outline-secondary" id="btnPostcode">주소 찾기</button>
                            </div>
                            <div class="form-text">지번은 허용되지 않습니다. 도로명만 가능합니다.</div>
                            <div class="invalid-feedback">도로명 주소를 선택하세요.</div>
                        </div>

                        <!-- 우편번호 -->
                        <div class="mb-3">
                            <label class="form-label">우편번호</label>
                            <input type="text" class="form-control" id="zipcode" placeholder="5자리" readonly required>
                            <div class="invalid-feedback">우편번호가 유효하지 않습니다.</div>
                        </div>

                        <!-- 상세/메모 -->
                        <div class="mb-3">
                            <label th:for="*{detail}" class="form-label">상세 주소</label>
                            <input type="text" class="form-control" th:field="*{detail}" id="detail" maxlength="100" placeholder="동/호수 등" required>
                            <small class="text-danger" th:if="${#fields.hasErrors('detail')}" th:errors="*{detail}">error</small>
                            <div class="invalid-feedback">상세 주소를 입력하세요. (100자 이내)</div>
                        </div>

                        <div class="mb-3">
                            <label th:for="*{memo}" class="form-label">메모(선택)</label>
                            <input type="text" class="form-control" th:field="*{memo}" id="memo" maxlength="100" placeholder="문 앞 보관 금지 등">
                            <small class="text-danger" th:if="${#fields.hasErrors('memo')}" th:errors="*{memo}">error</small>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="asDefault">
                            <label class="form-check-label" for="asDefault">기본 배송지로 설정</label>
                        </div>

                        <!-- 서버 제출용 숨김 필드 -->
                        <input type="hidden" th:field="*{zipcode}" id="zipcodeHidden">
                        <input type="hidden" th:field="*{streetName}" id="streetHidden">
                        <input type="hidden" th:field="*{main}" id="mainHidden">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                        <button type="submit" id="btnSubmit" class="btn btn-primary" disabled>등록</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 카카오(다음) 우편번호 -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // 버튼, 필드
        const btnPostcode = document.getElementById('btnPostcode');
        const roadEl = document.getElementById('roadAddress');
        const zipEl = document.getElementById('zipcode');
        const detailEl = document.getElementById('detail');
        const memoEl = document.getElementById('memo');
        const asDefaultEl = document.getElementById('asDefault');
        const submitBtn = document.getElementById('btnSubmit');

        const zipcodeHidden = document.getElementById('zipcodeHidden');
        const streetHidden  = document.getElementById('streetHidden');
        const mainHidden    = document.getElementById('mainHidden');

        function validate() {
            const zipOk = /^[0-9]{5}$/.test(zipEl.value.trim());
            const road = roadEl.value.trim();
            const detail = detailEl.value.trim();
            const roadOk = road.length > 0 && !/번지|지번/.test(road) && road.length <= 200;
            const detailOk = detail.length > 0 && detail.length <= 100;

            roadEl.classList.toggle('is-invalid', !roadOk && road.length > 0);
            zipEl.classList.toggle('is-invalid', !zipOk && zipEl.value.length > 0);
            detailEl.classList.toggle('is-invalid', !detailOk && detail.length > 0);

            // hidden sync
            zipcodeHidden.value = zipOk && roadOk ? zipEl.value.trim() : '';
            streetHidden.value  = zipOk && roadOk ? road : '';
            mainHidden.value    = asDefaultEl.checked ? 'true' : 'false';

            submitBtn.disabled = !(zipOk && roadOk && detailOk);
        }

        // 카카오 팝업
        btnPostcode?.addEventListener('click', function () {
            new daum.Postcode({
                oncomplete: function (data) {
                    if (data.userSelectedType !== 'R') {
                        alert('지번 주소는 사용할 수 없습니다. 도로명 주소를 선택하세요.');
                        return;
                    }
                    zipEl.value = data.zonecode;
                    roadEl.value = data.roadAddress;
                    detailEl.focus();
                    validate();
                }
            }).open();
        });

        [detailEl, memoEl, asDefaultEl].forEach(el => {
            el?.addEventListener('input', validate);
            el?.addEventListener('change', validate);
        });

        // 최초 비활성화 보장
        validate();
    </script>
</section>
</html>
