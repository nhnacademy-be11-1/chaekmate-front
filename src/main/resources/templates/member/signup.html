<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<section>

  <div class="container-fluid">
    <div class="row px-xl-5">
      <div class="col-lg-8 mb-5 mx-auto">
        <div class="bg-light p-30">
          <h2 class="mb-4">회원가입</h2>

          <!-- 컨트롤러가 @ModelAttribute로 받으므로 폼 전송으로 변경 -->
          <form method="post" th:action="@{/signup}" id="signupForm" novalidate>

            <div class="row">
              <div class="col-md-12 form-group">
                <label for="loginId">Login ID</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="loginId" name="loginId"
                         maxlength="20" required placeholder="예) user123">
                  <button type="button" class="btn btn-outline-secondary" id="btnCheckLoginId">중복확인</button>
                </div>
                <small class="text-muted">최대 20자</small>
                <small id="loginIdMsg" class="d-block mt-1"></small>
              </div>

              <div class="col-md-12 form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password"
                       minlength="8" maxlength="100" required placeholder="8~100자">
              </div>

              <div class="col-md-12 form-group">
                <label for="name">이름</label>
                <input type="text" class="form-control" id="name" name="name"
                       maxlength="50" required placeholder="홍길동">
              </div>

              <div class="col-md-12 form-group">
                <label for="phone">전화번호</label>
                <input type="tel" class="form-control" id="phone" name="phone"
                       pattern="^[0-9\-]{9,20}$" required placeholder="010-1234-5678">
                <small class="text-muted">숫자와 하이픈만, 9~20자</small>
              </div>

              <div class="col-md-12 form-group">
                <label for="email">이메일</label>
                <div class="input-group">
                  <input type="email" class="form-control" id="email" name="email"
                         maxlength="50" required placeholder="user@example.com">
                  <button type="button" class="btn btn-outline-secondary" id="btnCheckEmail">중복확인</button>
                </div>
                <small id="emailMsg" class="d-block mt-1"></small>
              </div>

              <div class="col-md-12 form-group">
                <label for="birthDate">생년월일</label>
                <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                <small class="text-muted">형식: YYYY-MM-DD</small>
              </div>

              <div class="col-md-12">
                <button type="submit" class="btn btn-primary">회원가입</button>
              </div>

              <div class="col-md-12 mt-3 text-center">
                <span>이미 계정이 있으신가요? </span>
                <a href="/login" class="text-primary">로그인</a>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

  <script>
    const loginIdEl  = document.getElementById('loginId');
    const emailEl    = document.getElementById('email');
    const loginIdMsg = document.getElementById('loginIdMsg');
    const emailMsg   = document.getElementById('emailMsg');
    const form       = document.getElementById('signupForm');

    function setMsg(el, text, ok) {
      el.textContent = text || '';
      el.classList.remove('text-success','text-danger','text-muted');
      if (!text) el.classList.add('text-muted');
      else el.classList.add(ok ? 'text-success' : 'text-danger');
    }

    async function checkLoginId() {
      const v = loginIdEl.value.trim();
      if (!v) { setMsg(loginIdMsg, '아이디를 입력하세요.', false); return false; }
      const res = await fetch(`/members/check-login-id?loginId=${encodeURIComponent(v)}`);
      const data = await res.json();
      if (data.available) { setMsg(loginIdMsg, '사용 가능한 아이디입니다.', true); return true; }
      setMsg(loginIdMsg, '이미 사용 중인 아이디입니다.', false); return false;
    }

    async function checkEmail() {
      const v = emailEl.value.trim();
      if (!v) { setMsg(emailMsg, '이메일을 입력하세요.', false); return false; }
      const res = await fetch(`/members/check-email?email=${encodeURIComponent(v)}`);
      const data = await res.json();
      if (data.available) { setMsg(emailMsg, '사용 가능한 이메일입니다.', true); return true; }
      setMsg(emailMsg, '이미 사용 중인 이메일입니다.', false); return false;
    }

    // 버튼 클릭
    document.getElementById('btnCheckLoginId').addEventListener('click', checkLoginId);
    document.getElementById('btnCheckEmail').addEventListener('click', checkEmail);

    // blur 시 자동 체크(선택)
    loginIdEl.addEventListener('blur', () => { if (loginIdEl.value) checkLoginId(); });
    emailEl.addEventListener('blur',    () => { if (emailEl.value) checkEmail();    });

    // 제출 전 최종 방어: 둘 다 OK 아니면 막기
    form.addEventListener('submit', async (e) => {
      if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); form.reportValidity(); return; }
      const [okId, okEmail] = await Promise.all([checkLoginId(), checkEmail()]);
      if (!okId || !okEmail) { e.preventDefault(); e.stopPropagation(); }
    });

    // 오늘 날짜 이후 선택 방지 (유지)
    (function lockFutureDate() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      document.getElementById('birthDate').setAttribute('max', `${yyyy}-${mm}-${dd}`);
    })();

    // HTML5 기본 검증만 사용. fetch로 가로채지 않음.
    document.getElementById('signupForm').addEventListener('submit', function (e) {
      if (!e.target.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        e.target.reportValidity();
      }
    });
  </script>

</section>
</html>
