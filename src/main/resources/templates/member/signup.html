<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<section>

  <div class="container-fluid">
    <div class="row px-xl-5">
      <div class="col-lg-8 mb-5 mx-auto">
        <div class="bg-light p-30">
          <h2 class="mb-4">회원가입</h2>

          <!-- 컨트롤러가 @ModelAttribute로 받으므로 폼 전송 유지 -->
          <form method="post" th:action="@{/signup}" id="signupForm" novalidate>
            <div class="row">
              <!-- 로그인 아이디 -->
              <div class="col-md-12 form-group">
                <label for="loginId">Login ID</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="loginId" name="loginId"
                         maxlength="20" required autocomplete="username"
                         placeholder="예) user123">
                  <button type="button" class="btn btn-outline-secondary" id="btnCheckLoginId">
                    중복확인
                  </button>
                </div>
                <small class="text-muted">최대 20자</small>
                <small id="loginIdMsg" class="d-block mt-1" aria-live="polite"></small>
              </div>

              <!-- 비밀번호 -->
              <div class="col-md-12 form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password"
                       minlength="8" maxlength="100" required autocomplete="new-password"
                       placeholder="8~100자">
                <small id="pwMsg" class="d-block mt-1 text-muted">영문/숫자/기호 조합 권장</small>
              </div>

              <!-- 비밀번호 확인 -->
              <div class="col-md-12 form-group">
                <label for="passwordConfirm">Password 확인</label>
                <input type="password" class="form-control" id="passwordConfirm"
                       minlength="8" maxlength="100" required autocomplete="new-password"
                       placeholder="비밀번호 재입력">
                <small id="pwConfirmMsg" class="d-block mt-1" aria-live="polite"></small>
              </div>

              <!-- 이름 -->
              <div class="col-md-12 form-group">
                <label for="name">이름</label>
                <input type="text" class="form-control" id="name" name="name"
                       maxlength="50" required placeholder="홍길동" autocomplete="name">
              </div>

              <!-- 전화번호: 자동 하이픈 포맷 -->
              <div class="col-md-12 form-group">
                <label for="phone">전화번호</label>
                <input type="tel" class="form-control" id="phone" name="phone"
                       inputmode="numeric" autocomplete="tel"
                       pattern="^[0-9\-]{9,20}$" required placeholder="010-1234-5678">
              </div>

              <!-- 이메일 -->
              <div class="col-md-12 form-group">
                <label for="email">이메일</label>
                <div class="input-group">
                  <input type="email" class="form-control" id="email" name="email"
                         maxlength="50" required autocomplete="email"
                         placeholder="user@example.com">
                  <button type="button" class="btn btn-outline-secondary" id="btnCheckEmail">
                    중복확인
                  </button>
                </div>
                <small id="emailMsg" class="d-block mt-1" aria-live="polite"></small>
              </div>

              <!-- 생년월일 -->
              <div class="col-md-12 form-group">
                <label for="birthDate">생년월일</label>
                <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                <small class="text-muted">형식: YYYY-MM-DD</small>
              </div>

              <!-- 제출 -->
              <div class="col-md-12">
                <button type="submit" class="btn btn-primary" id="btnSubmit" disabled>회원가입</button>
              </div>

              <div class="col-md-12 mt-3 text-center">
                <span>이미 계정이 있으신가요? </span>
                <a href="/login" class="text-primary">로그인</a>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

  <script>
    // 엘리먼트 참조
    const $form = document.getElementById('signupForm');
    const $submit = document.getElementById('btnSubmit');

    const $loginId = document.getElementById('loginId');
    const $btnCheckLoginId = document.getElementById('btnCheckLoginId');
    const $loginIdMsg = document.getElementById('loginIdMsg');

    const $email = document.getElementById('email');
    const $btnCheckEmail = document.getElementById('btnCheckEmail');
    const $emailMsg = document.getElementById('emailMsg');

    const $pw = document.getElementById('password');
    const $pwMsg = document.getElementById('pwMsg');
    const $pw2 = document.getElementById('passwordConfirm');
    const $pwConfirmMsg = document.getElementById('pwConfirmMsg');

    const $phone = document.getElementById('phone');
    const $birth = document.getElementById('birthDate');

    // 상태 플래그
    let idChecked = false;
    let emailChecked = false;
    let lastCheckedId = null;
    let lastCheckedEmail = null;

    // 메시지 헬퍼
    function setMsg($el, text, type) {
      $el.textContent = text || '';
      $el.classList.remove('text-success','text-danger','text-muted');
      if (!text) $el.classList.add('text-muted');
      else if (type === 'ok') $el.classList.add('text-success');
      else if (type === 'err') $el.classList.add('text-danger');
    }

    function updateSubmitState() {
      const pwOk = $pw.value.length >= 8 && $pw.value === $pw2.value;
      const allOk = idChecked && emailChecked && pwOk && $form.checkValidity();
      $submit.disabled = !allOk;
    }

    // 아이디 중복 확인
    async function checkLoginId() {
      const v = $loginId.value.trim();
      if (!v) { setMsg($loginIdMsg, '아이디를 입력하세요.', 'err'); idChecked = false; updateSubmitState(); return false; }

      $btnCheckLoginId.disabled = true;
      setMsg($loginIdMsg, '확인 중...', null);
      try {
        const res = await fetch(`/members/check-login-id?loginId=${encodeURIComponent(v)}`, {
          method: 'GET', headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          setMsg($loginIdMsg, err.message || '중복 확인 실패', 'err');
          idChecked = false;
          updateSubmitState();
          return false;
        }
        const data = await res.json();
        if (data.available) {
          setMsg($loginIdMsg, '사용 가능한 아이디입니다.', 'ok');
          idChecked = true;
          lastCheckedId = v;
          updateSubmitState();
          return true;
        } else {
          setMsg($loginIdMsg, '이미 사용 중인 아이디입니다.', 'err');
          idChecked = false;
          updateSubmitState();
          return false;
        }
      } catch {
        setMsg($loginIdMsg, '네트워크 오류가 발생했습니다.', 'err');
        idChecked = false;
        updateSubmitState();
        return false;
      } finally {
        $btnCheckLoginId.disabled = false;
      }
    }

    // 이메일 중복 확인
    async function checkEmail() {
      const v = $email.value.trim();
      if (!v) { setMsg($emailMsg, '이메일을 입력하세요.', 'err'); emailChecked = false; updateSubmitState(); return false; }

      $btnCheckEmail.disabled = true;
      setMsg($emailMsg, '확인 중...', null);
      try {
        const res = await fetch(`/members/check-email?email=${encodeURIComponent(v)}`, {
          method: 'GET', headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          setMsg($emailMsg, err.message || '중복 확인 실패', 'err');
          emailChecked = false;
          updateSubmitState();
          return false;
        }
        const data = await res.json();
        if (data.available) {
          setMsg($emailMsg, '사용 가능한 이메일입니다.', 'ok');
          emailChecked = true;
          lastCheckedEmail = v;
          updateSubmitState();
          return true;
        } else {
          setMsg($emailMsg, '이미 사용 중인 이메일입니다.', 'err');
          emailChecked = false;
          updateSubmitState();
          return false;
        }
      } catch {
        setMsg($emailMsg, '네트워크 오류가 발생했습니다.', 'err');
        emailChecked = false;
        updateSubmitState();
        return false;
      } finally {
        $btnCheckEmail.disabled = false;
      }
    }

    // 비밀번호 일치 체크
    function validatePasswords() {
      if (!$pw.value && !$pw2.value) {
        setMsg($pwConfirmMsg, '', null);
      } else if ($pw.value.length < 8) {
        setMsg($pwConfirmMsg, '비밀번호는 8자 이상이어야 합니다.', 'err');
      } else if ($pw.value !== $pw2.value) {
        setMsg($pwConfirmMsg, '비밀번호가 일치하지 않습니다.', 'err');
      } else {
        setMsg($pwConfirmMsg, '비밀번호가 일치합니다.', 'ok');
      }
      updateSubmitState();
    }

    // 전화번호 자동 하이픈 (국내 간단 규칙)
    function formatPhone(value) {
      const digits = value.replace(/\D/g, '');
      // 02 국번 간단 처리, 그 외 3-4-4 패턴 우선
      if (digits.startsWith('02')) {
        if (digits.length <= 2) return digits;
        if (digits.length <= 5) return digits.replace(/(\d{2})(\d+)/, '$1-$2');
        if (digits.length <= 9) return digits.replace(/(\d{2})(\d{3,4})(\d{1,4})/, '$1-$2-$3');
        return digits.slice(0, 10).replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
      } else {
        if (digits.length <= 3) return digits;
        if (digits.length <= 7) return digits.replace(/(\d{3})(\d+)/, '$1-$2');
        return digits.slice(0, 11).replace(/(\d{3})(\d{3,4})(\d{1,4})/, '$1-$2-$3');
      }
    }

    // 이벤트 바인딩
    $btnCheckLoginId.addEventListener('click', checkLoginId);
    $btnCheckEmail.addEventListener('click', checkEmail);

    $loginId.addEventListener('input', () => {
      // 입력이 바뀌면 검증 무효화
      if ($loginId.value.trim() !== lastCheckedId) {
        idChecked = false;
        setMsg($loginIdMsg, '', null);
        updateSubmitState();
      }
    });
    $email.addEventListener('input', () => {
      if ($email.value.trim() !== lastCheckedEmail) {
        emailChecked = false;
        setMsg($emailMsg, '', null);
        updateSubmitState();
      }
    });

    $loginId.addEventListener('blur', () => { if ($loginId.value.trim()) checkLoginId(); });
    $email.addEventListener('blur', () => { if ($email.value.trim()) checkEmail(); });

    $pw.addEventListener('input', validatePasswords);
    $pw2.addEventListener('input', validatePasswords);

    $phone.addEventListener('input', (e) => {
      const pos = e.target.selectionStart;
      const before = e.target.value;
      e.target.value = formatPhone(before);
    });

    // 오늘 이후 생일 선택 방지
    (function lockFutureDate() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      $birth.setAttribute('max', `${yyyy}-${mm}-${dd}`);
    })();

    // 제출 전 최종 방어: 비동기 중복검사까지 강제 수행
    $form.addEventListener('submit', async (e) => {
      // HTML5 기본 검증 먼저
      if (!$form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        $form.reportValidity();
        return;
      }

      // 비밀번호 확인
      if ($pw.value.length < 8 || $pw.value !== $pw2.value) {
        e.preventDefault();
        e.stopPropagation();
        validatePasswords();
        return;
      }

      // 중복 체크 강제 실행
      const [okId, okEmail] = await Promise.all([
        idChecked && $loginId.value.trim() === lastCheckedId ? true : checkLoginId(),
        emailChecked && $email.value.trim() === lastCheckedEmail ? true : checkEmail()
      ]);

      if (!okId || !okEmail) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }

      // 여기까지 통과해야 전송
      updateSubmitState();
    });

    // 초기 상태
    setMsg($loginIdMsg, '', null);
    setMsg($emailMsg, '', null);
    setMsg($pwConfirmMsg, '', null);
    updateSubmitState();
  </script>

</section>
</html>
