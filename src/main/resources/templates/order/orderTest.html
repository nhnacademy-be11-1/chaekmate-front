<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">

<section>
    <link rel="stylesheet" th:href="@{/css/order.css}"/>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/">í™ˆ</a>
                    <a class="breadcrumb-item text-dark" href="/shop">ì„œì </a>
                    <span class="breadcrumb-item active">ì£¼ë¬¸ì„œ</span>
                </nav>
            </div>
        </div>
    </div>

    <form id="checkoutForm" class="container-fluid">
        <div class="row px-xl-5">
            <!-- ì¢Œì¸¡: ì£¼ë¬¸ ìƒí’ˆ -->
            <div class="col-lg-8">
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ì£¼ë¬¸ ìƒí’ˆ</span></h5>
                <div class="cm-card p-3 mb-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead>
                            <tr class="text-center">
                                <th style="width: 90px;">ìƒí’ˆ ì´ë¯¸ì§€</th>
                                <th style="width: 260px;">ìƒí’ˆ ì •ë³´</th>
                                <th style="width: 110px;">ì •ê°€</th>
                                <th style="width: 100px;">í• ì¸ìœ¨</th>
                                <th style="width: 120px;">í• ì¸ê°€ê²©</th>
                                <th style="width: 70px;">ìˆ˜ëŸ‰</th>
                                <th style="width: 120px;">ì´í•©ê³„</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr class="order-item-row"
                                th:each="item,idx : ${orderItems}"
                                th:data-book-id="${item.bookId}">

                                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                                <td class="text-center">
                                    <img th:src="${item.thumbnailUrl}"
                                         alt="ë„ì„œ í‘œì§€"
                                         class="cm-thumb">
                                </td>

                                <!-- ìƒí’ˆ ì •ë³´: ì œëª© + ì €ì (ê°™ì€ ì¹¸) -->
                                <td>
                                    <div class="cm-info">
                                        <div class="cm-title" th:text="${item.title}">ë„ì„œ ì œëª©</div>
                                        <div class="cm-author" th:text="${item.author}">ì €ìëª…</div>
                                    </div>

                                    <!-- ì¿ í° -->
                                    <div class="mt-2" th:if="${isLoggedIn}">
                                        <label class="mb-1 d-block">ì¿ í° ì ìš©</label>
                                        <select class="custom-select coupon-select">
                                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                                            <option value="3000">3,000ì› í• ì¸ ì¿ í°</option>
                                        </select>
                                    </div>

                                    <!-- í¬ì¸íŠ¸ -->
                                    <div class="mt-2" th:if="${isLoggedIn}">
                                        <label class="mb-1">í¬ì¸íŠ¸ ì‚¬ìš©</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control point-input"
                                                   placeholder="ì‚¬ìš© í¬ì¸íŠ¸ ì…ë ¥"
                                                   th:data-max="${member.remainingPoints}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary btn-max-point" type="button"
                                                        onclick="useMaxPoint(this)">ìµœëŒ€</button>
                                                <button class="btn btn-outline-primary ml-1 point-apply-btn" type="button"
                                                        onclick="togglePointApply(this)">ì ìš©</button>
                                            </div>
                                        </div>
                                        <small class="text-muted">ë³´ìœ  í¬ì¸íŠ¸: <b th:text="${member.remainingPoints}"></b>P</small>
                                    </div>

                                    <!-- í¬ì¥ì§€ -->
                                    <div class="mt-3">
                                        <label class="mb-1 d-block">í¬ì¥ì§€ ì„ íƒ</label>
                                        <div class="d-flex" th:with="wraps=${wrappers}">
                                            <label class="cm-wrap-tile mr-2">
                                                <input type="radio" th:name="'wrap_' + ${idx.index}" data-id=""
                                                       data-price="0" value="0" class="sr-only wrap-radio" checked>
                                                <span>ê¸°ë³¸ (ë¬´ë£Œ)</span>
                                            </label>

                                            <label class="cm-wrap-tile mr-2" th:each="wrapper : ${wraps}">
                                                <input type="radio"
                                                       th:name="'wrap_' + ${idx.index}"
                                                       th:data-id="${wrapper.id}"
                                                       th:data-price="${wrapper.price}"
                                                       th:value="${wrapper.price}"
                                                       class="sr-only wrap-radio">
                                                <span th:text="${wrapper.name + ' (+' + wrapper.price + 'ì›)'}"></span>
                                            </label>
                                        </div>
                                    </div>
                                </td>

                                <!-- ì •ê°€ -->
                                <td class="text-center">
            <span class="cm-price-original price"
                  th:text="${#numbers.formatInteger(item.originalPrice, 3, 'COMMA')} + 'ì›'">
            </span>
                                </td>

                                <!-- í• ì¸ìœ¨ -->
                                <td class="text-center">
            <span class="cm-discount"
                  th:text="${item.discountRate} + '%'"></span>
                                </td>

                                <!-- í• ì¸ê°€ê²© -->
                                <td class="text-center">
            <span class="cm-price-sale"
                  th:text="${#numbers.formatInteger(item.salesPrice, 3, 'COMMA')} + 'ì›'"></span>
                                </td>

                                <!-- ìˆ˜ëŸ‰ -->
                                <td class="text-center">
                                    <span class="qty" th:text="${item.quantity}">1</span>
                                </td>

                                <!-- ì´í•©ê³„ -->
                                <td class="text-center">
            <span class="subtotal cm-price-total"
                  th:text="${#numbers.formatInteger(item.subtotal, 3, 'COMMA')} + 'ì›'"></span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ğŸšš ë°°ì†¡ ì •ë³´ -->
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ë°°ì†¡ ì •ë³´</span></h5>
                <div class="cm-card p-3 mb-5">

                    <!-- ì£¼ë¬¸ì -->
                    <h6 class="font-weight-bold mb-3">ì£¼ë¬¸ì ì •ë³´</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="ordererName" name="ordererName"
                                   th:value="${isLoggedIn} ? ${member.name} : ''">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="ordererPhone" name="ordererPhone"
                                   th:value="${isLoggedIn} ? ${member.phone} : ''">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" class="form-control" id="ordererEmail" name="ordererEmail"
                                   th:value="${isLoggedIn} ? ${member.email} : ''">
                            <small class="form-text text-muted">* Dooray ë©”ì‹œì§€ ì „ì†¡ìš©</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- ìˆ˜ë ¹ì¸ -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="font-weight-bold mb-0">ìˆ˜ë ¹ì¸ ì •ë³´</h6>
                        <div>
                            <input type="checkbox" id="sameAsOrderer" class="mr-1">
                            <label for="sameAsOrderer" class="mb-0 small text-muted">ì£¼ë¬¸ì ì •ë³´ì™€ ë™ì¼</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="receiverName" name="receiverName">
                        </div>
                        <div class="form-group col-md-6">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="receiverPhone" name="receiverPhone">
                        </div>
                    </div>

                    <!-- ì£¼ì†Œ -->
                    <div class="form-group" th:if="${isLoggedIn}">
                        <label>ë°°ì†¡ì§€ ì„ íƒ</label>
                        <select class="custom-select" id="addressSelect" name="addressId">
                            <option value="">ë°°ì†¡ì§€ ì„ íƒ</option>
                            <option th:each="addr : ${addresses}"
                                    th:value="${addr.id}"
                                    th:data-road="${addr.streetName}"
                                    th:data-detail="${addr.detail}"
                                    th:data-postcode="${addr.zipcode}"
                                    th:text="${addr.memo + ' - ' + addr.streetName + ' ' + addr.detail}">
                            </option>
                        </select>
                    </div>

                    <!-- ì§ì ‘ ì…ë ¥ -->
                    <div class="form-group">
                        <label>ì§ì ‘ ì…ë ¥</label>
                        <div class="input-group mb-2">
                            <input type="text"
                                   class="form-control"
                                   id="postcode"
                                   placeholder="ìš°í¸ë²ˆí˜¸"
                                   readonly>

                            <div class="input-group-append">
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        style="white-space: nowrap;"
                                        onclick="findAddress()">
                                    ì£¼ì†Œ ê²€ìƒ‰
                                </button>
                            </div>
                        </div>

                        <input type="text" class="form-control mb-2" id="roadAddress" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>
                        <input type="text" class="form-control" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <textarea class="form-control" name="request" rows="2" placeholder="ì˜ˆ: ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ì¼ ì§€ì •</label>
                        <input type="date" class="form-control" id="deliveryDate" name="deliveryDate"
                               th:value="${defaultDeliveryDate}" th:attr="min=${defaultDeliveryDate}">
                        <small class="text-muted">* ê¸°ë³¸ ë°°ì†¡ì¼ì€ ì£¼ë¬¸ì¼ +3ì¼ì…ë‹ˆë‹¤.</small>
                    </div>
                </div>
            </div>

            <!-- ìš°: ê²°ì œ ì •ë³´ -->
            <div class="col-lg-4 sticky-wrapper">
                <div class="sticky-box">
                    <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ê²°ì œ ì •ë³´</span></h5>
                    <div class="cm-card p-3">
                        <!-- ì„œë²„ì—ì„œ ìƒì„±ëœ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ hiddenìœ¼ë¡œ -->
                        <input type="hidden" id="orderNumber" name="orderNumber">
                        <input type="hidden" id="orderName" name="orderName" th:value="${orderItems[0].title}">
                        <input type="hidden" id="price" name="price">
                        <input type="hidden" id="pointUsed" th:value="${summary.pointDiscount}">


                        <div class="cm-total-row"><span>ìƒí’ˆ í•©ê³„</span><span id="sum-products"
                                                                          th:text="${summary.productsTotal} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"  th:if="${isLoggedIn}"><span>ì¿ í° í• ì¸</span><span id="sum-coupon"
                                                                                                 th:text="'-' + ${summary.couponDiscount} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row" th:if="${isLoggedIn}"><span>í¬ì¸íŠ¸ ì‚¬ìš©</span> <span id="sum-point"
                                                                                                  th:text="'-' + ${summary.pointDiscount} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>í¬ì¥ë¹„</span><span id="sum-wrap"
                                                                        th:text="${summary.wrapFeeTotal} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>ë°°ì†¡ë¹„</span><span id="sum-shipping"
                                                                        th:text="${summary.shippingFee} + 'ì›'"></span>
                        </div>
                        <small id="free-shipping-info" class="text-muted d-block mt-1">
                            [[${deliveryPolicy.freeStandardAmount}]]ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡
                        </small>
                        <div class="cm-total-row cm-strong">
                            <span>ì´ ê²°ì œê¸ˆì•¡</span><span id="sum-total" th:text="${summary.payableTotal} + 'ì›'"></span>
                        </div>

                        <button type="submit" class="btn btn-block btn-primary font-weight-bold py-3 mt-3">
                            ê²°ì œí•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- ê²°ì œ ëª¨ë‹¬ -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <h4>ê²°ì œ ì§„í–‰</h4>
            <!-- ê²°ì œ ìˆ˜ë‹¨ UI -->
            <div id="payment-method"></div>
            <!-- ì•½ê´€ UI -->
            <div id="agreement" class="mt-3"></div>
            <!-- ê²°ì œ ë²„íŠ¼ -->
            <button id="payButton" class="btn btn-primary btn-block mt-4">ê²°ì œí•˜ê¸°</button>
            <!-- ì·¨ì†Œ ë²„íŠ¼ -->
            <button id="cancelModalBtn" class="btn btn-light border btn-block mt-2">ë‹«ê¸°</button>
        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // ë°°ì†¡ ì •ì±…
            const policy = {
                freeStandardAmount: /*[[${deliveryPolicy.freeStandardAmount}]]*/,
                deliveryFee: /*[[${deliveryPolicy.deliveryFee}]]*/
            };

            // ìˆ«ì í¬ë§·/íŒŒì‹±
            const fmt = n => (isNaN(n) ? 0 : n).toLocaleString('ko-KR') + 'ì›';
            const num = v => {
                const n = parseInt(String(v).replace(/[^\d-]/g, ''), 10);
                return isNaN(n) ? 0 : n;
            };

            // í•©ê³„ ìƒíƒœ
            // í•©ê³„ ìƒíƒœ
            const summary = {
                productsTotal: 0,
                couponDiscount: 0,
                pointDiscount: 0,
                wrapFeeTotal: 0,
                shippingFee: policy.deliveryFee
            };

            // í¬ì¸íŠ¸ ì ê¸ˆ ê´€ë ¨ ìƒíƒœ
            let pointLocked = false;         // trueë©´ ìš°ì¸¡ í¬ì¸íŠ¸ ê°’ ê³ ì •
            let lockedPointDiscount = 0;     // ì ê¸ˆ ì‹œ ì €ì¥í•´ë‘˜ í¬ì¸íŠ¸ ê°’


            // DOM í—¬í¼
            const $ = (sel) => document.querySelector(sel);
            const $$ = (sel) => Array.from(document.querySelectorAll(sel));

            // ë³´ìœ  í¬ì¸íŠ¸ ìµœëŒ€ê°’ (member.remainingPoints)
            const getPointMaxTotal = () => {
                const any = $('.point-input');
                return any ? num(any.dataset.max || 0) : 0;
            };

            const setText = (sel, text) => {
                const el = document.querySelector(sel);
                if (el) el.textContent = text;
            };

            // í•©ê³„ ì¬ê³„ì‚°
            const recalc = () => {
                // 1) ìƒí’ˆ ì´í•©
                summary.productsTotal = $$('.subtotal')
                    .map(td => num(td.textContent))
                    .reduce((a, b) => a + b, 0);

                // 2) ì¿ í° í•©ê³„
                summary.couponDiscount = $$('.coupon-select')
                    .map(sel => num(sel.value))
                    .reduce((a, b) => a + b, 0);

                // 3) í¬ì¸íŠ¸ í•©ê³„
                if (!pointLocked) {
                    // ğŸ”“ ì•„ì§ ì ìš© ì•ˆ ëœ ìƒíƒœ â†’ input ê°’ ê¸°ì¤€ìœ¼ë¡œ í•­ìƒ ì¬ê³„ì‚°
                    const rawPointSum = $$('.point-input')
                        .map(input => num(input.value))
                        .reduce((a, b) => a + b, 0);
                    summary.pointDiscount = Math.min(rawPointSum, getPointMaxTotal());
                } else {
                    // ğŸ”’ ì ìš© ë²„íŠ¼ ëˆŒëŸ¬ì„œ ì ê¸´ ìƒíƒœ â†’ ì €ì¥í•´ ë‘” ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    summary.pointDiscount = lockedPointDiscount;
                }


                // (4) í¬ì¥ë¹„ ê³„ì‚° (í•­ëª©ë³„ * ìˆ˜ëŸ‰ ì ìš©)
                summary.wrapFeeTotal = 0;

                // ê° ì£¼ë¬¸ í–‰ ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚°
                $$('.order-item-row').forEach(row => {
                    const selected = row.querySelector('.wrap-radio:checked');
                    if (!selected) return; // ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ìŠ¤í‚µ

                    const wrapPrice = num(selected.dataset.price); // ì„ íƒí•œ í¬ì¥ì§€ ê°€ê²©

                    // ìˆ˜ëŸ‰ ê³±í•˜ì§€ ì•ŠìŒ â†’ í–‰ë‹¹ í¬ì¥ë¹„ 1ë²ˆë§Œ ë¶€ê³¼
                    summary.wrapFeeTotal += wrapPrice;
                });

                // 5) ë°°ì†¡ë¹„ (ë¬´ë£Œë°°ì†¡ ì¡°ê±´ ì²´í¬)
                summary.shippingFee =
                    summary.productsTotal >= policy.freeStandardAmount
                        ? 0
                        : policy.deliveryFee;

                // 6) ì´ ê²°ì œê¸ˆì•¡
                let total =
                    summary.productsTotal
                    - summary.couponDiscount
                    - summary.pointDiscount
                    + summary.wrapFeeTotal
                    + summary.shippingFee;

                if (total < 0) {
                    total = 0;

                    // ğŸ”“ ì ìš© ì „ì¼ ë•Œë§Œ ìë™ìœ¼ë¡œ í¬ì¸íŠ¸ ì¡°ì •
                    if (!pointLocked) {
                        summary.pointDiscount =
                            summary.productsTotal
                            - summary.couponDiscount
                            + summary.wrapFeeTotal
                            + summary.shippingFee;
                    }
                }


                // ìš°ì¸¡ ìš”ì•½ UI ì—…ë°ì´íŠ¸
                $('#sum-products').textContent = fmt(summary.productsTotal);
                setText('#sum-coupon', '-' + fmt(summary.couponDiscount));
                setText('#sum-point', '-' + fmt(summary.pointDiscount));
                $('#sum-wrap').textContent = fmt(summary.wrapFeeTotal);
                $('#sum-shipping').textContent = fmt(summary.shippingFee);
                $('#sum-total').textContent = fmt(total);

                const infoEl = document.getElementById('free-shipping-info');
                if (infoEl) {
                    if (summary.shippingFee === 0) {
                        infoEl.textContent = 'ë¬´ë£Œë°°ì†¡ ì ìš©ë¨ ğŸ‰';
                    } else {
                        infoEl.textContent =
                            policy.freeStandardAmount.toLocaleString() + 'ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡';
                    }
                }

                // hidden ê°’ ë™ê¸°í™”
                const priceHidden = document.getElementById('price');
                if (priceHidden) priceHidden.value = total;

                const pointUsedHidden = document.getElementById('pointUsed');
                if (pointUsedHidden) pointUsedHidden.value = summary.pointDiscount;

                return total;
            };

            //  ì£¼ë¬¸ì/ìˆ˜ë ¹ì¸, ì£¼ì†Œ ê´€ë ¨ ë¡œì§

            // ì£¼ë¬¸ì ì •ë³´ = ìˆ˜ë ¹ì¸ ì •ë³´ ë³µì‚¬
            const sameCheck = $('#sameAsOrderer');
            if (sameCheck) {
                sameCheck.addEventListener('change', e => {
                    const on = e.target.checked;
                    $('#receiverName').value = on ? ($('#ordererName').value || '') : '';
                    $('#receiverPhone').value = on ? ($('#ordererPhone').value || '') : '';
                });
            }

            // ë°°ì†¡ì¼ ê¸°ë³¸ê°’ = ì˜¤ëŠ˜ + 3ì¼
            const deliveryDate = $('#deliveryDate');
            if (deliveryDate) {
                const today = new Date();
                today.setDate(today.getDate() + 3);
                deliveryDate.min = today.toISOString().split('T')[0];
                if (!deliveryDate.value) {
                    deliveryDate.value = deliveryDate.min;
                }
            }

            // ì €ì¥ëœ ë°°ì†¡ì§€ ì„ íƒ ì‹œ ìë™ ì±„ìš°ê¸°
            const addressSelect = document.getElementById("addressSelect");
            if (addressSelect) {
                addressSelect.addEventListener("change", (e) => {
                    const selected = e.target.selectedOptions[0];
                    if (!selected) return;

                    const postcode = selected.dataset.postcode || "";
                    const road = selected.dataset.road || "";
                    const detail = selected.dataset.detail || "";

                    document.getElementById("postcode").value = postcode;
                    document.getElementById("roadAddress").value = road;
                    document.getElementById("detailAddress").value = detail;

                    console.log("[ë°°ì†¡ì§€ ì„ íƒ]", {postcode, road, detail});
                });
            }

            // ì£¼ì†Œ ê²€ìƒ‰ API
            window.findAddress = function () {
                new daum.Postcode({
                    oncomplete: function (data) {
                        const roadAddr = data.roadAddress;
                        const jibunAddr = data.jibunAddress;
                        const zonecode = data.zonecode;
                        const buildingName = data.buildingName || '';

                        document.getElementById("postcode").value = zonecode;
                        document.getElementById("roadAddress").value = roadAddr;

                        const detailInput = document.getElementById("detailAddress");
                        if (detailInput) {
                            detailInput.value = "";
                            detailInput.focus();
                        }

                        const select = document.getElementById("addressSelect");
                        if (select) {
                            select.value = "";
                        }

                        console.log("ì„ íƒëœ ì£¼ì†Œ:", {
                            ë„ë¡œëª…ì£¼ì†Œ: roadAddr,
                            ì§€ë²ˆì£¼ì†Œ: jibunAddr,
                            ê±´ë¬¼ëª…: buildingName,
                            ìš°í¸ë²ˆí˜¸: zonecode
                        });
                    }
                }).open();
            };

            //   ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¿ í°/í¬ì¸íŠ¸/í¬ì¥)

            // ì¿ í° ë³€ê²½ ì‹œ
            $$('.coupon-select').forEach(sel => {
                sel.addEventListener('change', recalc);
            });

            // í¬ì¸íŠ¸ ì…ë ¥ ì‹œ
            $$('.point-input').forEach(input => {
                input.addEventListener('input', () => {
                    input.value = String(num(input.value)); // ìˆ«ìë§Œ ìœ ì§€

                    const max = getPointMaxTotal();       // ì´ ë³´ìœ  í¬ì¸íŠ¸
                    const values = $$('.point-input').map(i => num(i.value));
                    const thisValue = num(input.value);
                    const otherSum = values.reduce((a, b) => a + b, 0) - thisValue;

                    // ë‚¨ì€ í¬ì¸íŠ¸ ê³„ì‚°
                    const remain = max - otherSum;

                    // ì´ˆê³¼ ì‚¬ìš©í•œ ê²½ìš°
                    if (thisValue > remain) {
                        alert("ì‚¬ìš© ê°€ëŠ¥í•œ í¬ì¸íŠ¸ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!");
                        input.value = remain < 0 ? 0 : remain;
                    }

                    recalc();
                });
            });

            // í¬ì¥ì§€ ì„ íƒ ì‹œ
            $$('.wrap-radio').forEach(radio => {
                radio.addEventListener('change', () => {

                    // âœ” wrap ì„ íƒ UI ëŠ” td ë‚´ë¶€ì— ìˆìœ¼ë¯€ë¡œ td ê¸°ì¤€ìœ¼ë¡œ ì¡ì•„ì•¼ í•œë‹¤
                    const wrapTd = radio.closest('td');
                    const tiles = wrapTd.querySelectorAll('.cm-wrap-tile');

                    // ê¸°ì¡´ í…Œë‘ë¦¬ ì œê±°
                    tiles.forEach(t => t.classList.remove('selected'));

                    // ì„ íƒëœ ë¼ë²¨ë§Œ í™œì„±í™”
                    radio.closest('.cm-wrap-tile').classList.add('selected');

                    recalc(); // ê°€ê²© ì¬ê³„ì‚°
                });
            });

            // í¬ì¸íŠ¸ ìµœëŒ€ ë²„íŠ¼
            // - ë³´ìœ  í¬ì¸íŠ¸ í•œë„(getPointMaxTotal)
            // - í˜„ì¬ ê²°ì œ ê¸ˆì•¡ í•œë„(ìƒí’ˆí•©ê³„ - ì¿ í° + í¬ì¥ë¹„ + ë°°ì†¡ë¹„)
            // ë‘˜ ì¤‘ ë” ì‘ì€ ê°’ê¹Œì§€ë§Œ ì‚¬ìš©
            window.useMaxPoint = (btn) => {
                const input = btn.closest('.input-group')?.querySelector('.point-input');
                if (!input) return;

                // 1) "í¬ì¸íŠ¸ë¥¼ í•˜ë‚˜ë„ ì•ˆ ì¼ë‹¤ê³  ê°€ì •í–ˆì„ ë•Œ" ê²°ì œ ê¸ˆì•¡
                const baseTotal =
                    summary.productsTotal
                    - summary.couponDiscount
                    + summary.wrapFeeTotal
                    + summary.shippingFee;

                // 2) ë³´ìœ  í¬ì¸íŠ¸ / ê²°ì œê¸ˆì•¡ ê¸°ì¤€ í•œë„
                const maxPointByPrice = baseTotal;
                const maxPointByBalance = getPointMaxTotal();

                // 3) ë‹¤ë¥¸ input ë“¤ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ í¬ì¸íŠ¸
                const others = $$('.point-input')
                    .filter(i => i !== input)
                    .map(i => num(i.value))
                    .reduce((a, b) => a + b, 0);

                // 4) ì´ input ì´ ì“¸ ìˆ˜ ìˆëŠ” ë‚¨ì€ í¬ì¸íŠ¸
                const remain = Math.max(
                    0,
                    Math.min(maxPointByPrice, maxPointByBalance) - others
                );

                input.value = remain;
                recalc();
            };

            // í¬ì¸íŠ¸ ì ìš© / ìˆ˜ì • í† ê¸€
            window.togglePointApply = (btn) => {
                const group = btn.closest('.input-group');
                if (!group) return;

                const input = group.querySelector('.point-input');
                const maxBtn = group.querySelector('.btn-max-point');
                if (!input) return;

                const applied = btn.dataset.applied === 'true';

                if (!applied) {
                    // âœ… ì ìš© ìƒíƒœë¡œ ì „í™˜
                    // 1) í˜„ì¬ ì…ë ¥ê°’ ê¸°ì¤€ìœ¼ë¡œ í¬ì¸íŠ¸ ê³„ì‚°
                    recalc(); // summary.pointDiscount ìµœì‹ í™”

                    // 2) ê·¸ ê°’ì„ ì ê¸ˆ ê°’ìœ¼ë¡œ ì €ì¥
                    lockedPointDiscount = summary.pointDiscount;
                    pointLocked = true;

                    // 3) ì…ë ¥/ë²„íŠ¼ ì ê·¸ê¸°
                    input.readOnly = true;
                    if (maxBtn) maxBtn.disabled = true;

                    btn.dataset.applied = 'true';
                    btn.textContent = 'ìˆ˜ì •';

                } else {
                    // ğŸ” ë‹¤ì‹œ ìˆ˜ì • ê°€ëŠ¥ ìƒíƒœë¡œ ì „í™˜
                    pointLocked = false;
                    lockedPointDiscount = 0;

                    input.readOnly = false;
                    if (maxBtn) maxBtn.disabled = false;

                    btn.dataset.applied = 'false';
                    btn.textContent = 'ì ìš©';

                    // ë‹¤ì‹œ ììœ ë¡­ê²Œ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë‹ˆ, í˜„ì¬ input ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
                    recalc();
                }
            };

            // ê³„ì‚°
            recalc();

            //   ì£¼ë¬¸ submit (paymentType ë¶„ê¸°)
            const checkoutForm = document.getElementById("checkoutForm");
            const paymentModal = document.getElementById("paymentModal");
            const cancelModalBtn = document.getElementById("cancelModalBtn");

            function buildOrderSaveRequest() {
                // orderer / receiver / address ë“± form ê°’ ì½ê¸°
                const ordererName = document.getElementById("ordererName").value;
                const ordererPhone = document.getElementById("ordererPhone").value;
                const ordererEmail = document.getElementById("ordererEmail").value;

                const receiverName = document.getElementById("receiverName").value;
                const receiverPhone = document.getElementById("receiverPhone").value;

                const zipcode = document.getElementById("postcode").value;
                const streetName = document.getElementById("roadAddress").value;
                const detail = document.getElementById("detailAddress").value;

                const deliveryAt = document.getElementById("deliveryDate").value;
                const requestText = document.querySelector("textarea[name=request]").value;

                // ì£¼ë¬¸ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
                const orderedBooks = $$('.order-item-row').map((row, idx) => {
                    const bookId = Number(row.dataset.bookId);
                    const quantity = Number(row.querySelector(".qty").textContent);
                    const originalPrice = num(row.querySelector(".price").textContent);
                    const subtotal = num(row.querySelector(".subtotal").textContent);


                    const wrap = row.querySelector(".wrap-radio:checked");
                    const wrapperId = wrap?.dataset.id ? Number(wrap.dataset.id) : null;
                    const wrapperPrice = wrap ? Number(wrap.dataset.price) : 0;

                    const coupon = row.querySelector(".coupon-select");
                    const couponDiscount = coupon?.value ? Number(coupon.value) : 0;

                    const pointInput = row.querySelector(".point-input");
                    const pointUsed = pointInput ? Number(pointInput.value) : 0;

                    return {
                        bookId,
                        quantity,
                        originalPrice,
                        salesPrice: null,
                        discountPrice: null,
                        wrapperId,
                        wrapperPrice,
                        issuedCouponId: null,
                        couponDiscount,
                        pointUsed,
                        finalUnitPrice: subtotal / quantity
                    };
                });

                // ìµœì¢… DTO (OrderSaveRequest)
                return {
                    ordererName: ordererName,
                    ordererPhone: ordererPhone,
                    ordererEmail: ordererEmail,

                    recipientName: receiverName,
                    recipientPhone: receiverPhone,

                    zipcode,
                    streetName,
                    detail,
                    deliveryRequest: requestText,
                    deliveryAt,

                    deliveryFee: summary.shippingFee,
                    totalPrice: summary.productsTotal
                        - summary.couponDiscount
                        - summary.pointDiscount
                        + summary.wrapFeeTotal
                        + summary.shippingFee,

                    orderedBooks
                };
            }

            checkoutForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const total = recalc();

                // ì„œë²„ë¡œ ë³´ë‚¼ ì£¼ë¬¸ ì €ì¥ DTO êµ¬ì„±
                const saveRequest = buildOrderSaveRequest();  // âœ¨ ì•„ë˜ì—ì„œ ë§Œë“¤ì–´ì¤„ í•¨ìˆ˜

                // 1) ì£¼ë¬¸ ì €ì¥ API í˜¸ì¶œ (í”„ë¡ íŠ¸ â†’ í”„ë¡ íŠ¸ OrderController â†’ core)
                const response = await fetch("/orders/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(saveRequest)
                }).then(r => r.json());

                const {orderNumber, totalPrice} = response;

                // hidden ê°’ ì—…ë°ì´íŠ¸
                document.getElementById("orderNumber").value = orderNumber;
                document.getElementById("price").value = totalPrice;


                // ì´ ê²°ì œê¸ˆì•¡ 0ì› â†’ í¬ì¸íŠ¸ ì „ì•¡ ê²°ì œ
                if (total === 0) {
                    checkoutForm.action = "/payments/point";
                    checkoutForm.method = "post";
                    checkoutForm.submit();
                    return;
                }

                // TOSS ê²°ì œ â†’ ëª¨ë‹¬ ì—´ê¸°
                resetTossModal();
                paymentModal.style.display = "block";
                initTossPayment();
            });

            if (cancelModalBtn) {
                cancelModalBtn.onclick = () => paymentModal.style.display = "none";
                resetTossModal();
            }

            function resetTossModal() {
                // toss ìœ„ì ¯ DOM ì´ˆê¸°í™”
                $("#payment-method").innerHTML = "";
                $("#agreement").innerHTML = "";
            }
        });

        // Toss ê²°ì œ ì‹œì‘
        async function initTossPayment() {
            const $ = document.querySelector.bind(document);

            const orderId = $('#orderNumber').value;
            const orderName = $('#orderName').value;
            const totalAmount = Number($('#price').value);
            const pointUsed = $('#pointUsed').value;

            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);

            const widgets = tossPayments.widgets({customerKey: orderId});

            await widgets.setAmount({
                currency: "KRW",
                value: totalAmount
            });

            await widgets.renderPaymentMethods({
                selector: "#payment-method",
                variantKey: "DEFAULT"
            });

            await widgets.renderAgreement({
                selector: "#agreement",
                variantKey: "AGREEMENT"
            });

            $("#payButton").onclick = async function () {
                try {
                    await widgets.requestPayment({
                        orderId,
                        orderName,
                        // í¬ì¸íŠ¸ ì‚¬ìš©ëŸ‰ì„ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì½œë°±ì— ì „ë‹¬
                        successUrl: `${window.location.origin}/payments/success?pointUsed=${pointUsed}`,
                        failUrl: `${window.location.origin}/payments/fail`
                    });
                } catch (err) {

                    // í•„ìˆ˜ ì•½ê´€ ë™ì˜ ì•ˆ í•¨
                    if (err && err.code === "NEED_AGREEMENT" || String(err.message).includes("í•„ìˆ˜")) {
                        alert("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì•¼ ê²°ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }

                    // ê·¸ ì™¸ í† ìŠ¤ ì˜¤ë¥˜ ì¶œë ¥
                    console.error("ê²°ì œ ì˜¤ë¥˜:", err);
                    alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            };
        }
    </script>

</section>
</html>