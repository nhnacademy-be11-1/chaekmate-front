<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">

<section>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        /* ------- ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) ------- */
        .cm-card {
            background: var(--light);
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: .25rem;
        }

        .cm-section-title {
            position: relative;
            display: inline-block;
            padding: .25rem .75rem;
            background: var(--secondary);
            color: var(--dark);
            text-transform: uppercase;
        }

        .cm-total-row {
            display: flex;
            justify-content: space-between;
            padding: .25rem 0;
        }

        .cm-total-row.cm-strong {
            border-top: 1px solid rgba(0, 0, 0, .1);
            margin-top: .5rem;
            padding-top: .75rem;
            font-weight: 600;
        }

        .cm-wrap-tile {
            border: 1px solid rgba(0, 0, 0, .08);
            border-radius: .25rem;
            padding: .5rem;
            cursor: pointer;
        }

        .cm-wrap-tile.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 211, 51, .25);
        }

        @keyframes cm-shine {
            0% {
                background-position: 200% 0
            }
            100% {
                background-position: -200% 0
            }
        }

        .sticky-wrapper {
            position: relative;
        }

        @media (min-width: 992px) {
            .sticky-box {
                position: sticky;
                top: 100px;
            }
        }

        /* Toss ê²°ì œ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,.5);
        }
        .modal-content {
            background: #fff;
            margin: 6% auto;
            padding: 2rem;
            border-radius: .5rem;
            width: 420px;
            box-shadow: 0 2px 8px rgba(0,0,0,.25);
            animation: fadeIn .25s ease-in-out;
        }
        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-10px);}
            to {opacity: 1; transform: translateY(0);}
        }
        .close {
            float: right;
            font-size: 1.25rem;
            cursor: pointer;
        }
        #payment-button {
            width: 100%;
            margin-top: 1rem;
            padding: .75rem;
            background-color: #0064ff;
            color: white;
            border: none;
            border-radius: .25rem;
            font-weight: 600;
        }
        #payment-button:hover { background-color: #004ed9; }

    </style>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/">í™ˆ</a>
                    <a class="breadcrumb-item text-dark" href="/shop">ì„œì </a>
                    <span class="breadcrumb-item active">ì£¼ë¬¸ì„œ</span>
                </nav>
            </div>
        </div>
    </div>

    <form id="checkoutForm" class="container-fluid" th:action="@{/payments}" method="post">
        <div class="row px-xl-5">
            <!-- ì¢Œì¸¡: ì£¼ë¬¸ ìƒí’ˆ -->
            <div class="col-lg-8">
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ì£¼ë¬¸ ìƒí’ˆ</span></h5>
                <div class="cm-card p-3 mb-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead>
                            <tr class="text-dark">
                                <th style="width:64px">í‘œì§€</th>
                                <th>ìƒí’ˆëª…</th>
                                <th class="text-right">ê°€ê²©</th>
                                <th class="text-center">ìˆ˜ëŸ‰</th>
                                <th class="text-right">ì†Œê³„</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item,idx : ${orderItems}">
                                <td><img th:src="@{${item.thumbnailUrl}}" class="img-fluid rounded"
                                         style="max-width:48px;"></td>
                                <td>
                                    <div class="font-weight-bold" th:text="${item.name}">ì±… ì œëª©</div>
                                    <small class="text-muted d-block" th:text="${item.author}">ì €ì</small>

                                    <!-- ì¿ í° -->
                                    <div class="mt-2">
                                        <label class="mb-1 d-block">ì¿ í° ì ìš©</label>
                                        <select class="custom-select coupon-select" th:data-price="${item.price}">
                                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                                            <option value="3000">3,000ì› í• ì¸ ì¿ í°</option>
                                            <option value="5000">5,000ì› í• ì¸ ì¿ í°</option>
                                        </select>
                                    </div>

                                    <!-- í¬ì¸íŠ¸ -->
                                    <div class="mt-2">
                                        <label class="mb-1">í¬ì¸íŠ¸ ì‚¬ìš©</label>
                                        <div class="input-group">
                                            <input type="number" min="0" class="form-control point-input"
                                                   placeholder="ì‚¬ìš© í¬ì¸íŠ¸ ì…ë ¥" th:data-max="${member.remainingPoints}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="useMaxPoint(this)">ìµœëŒ€
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted">ë³´ìœ  í¬ì¸íŠ¸: <b
                                                th:text="${member.remainingPoints}">18000</b>P</small>
                                    </div>

                                    <!-- í¬ì¥ì§€ -->
                                    <div class="mt-3">
                                        <label class="mb-1 d-block">í¬ì¥ì§€ ì„ íƒ</label>
                                        <div class="d-flex">
                                            <label class="cm-wrap-tile mr-2">
                                                <input type="radio" name="wrap" value="0" class="sr-only wrap-radio">
                                                <span>ê¸°ë³¸ (ë¬´ë£Œ)</span>
                                            </label>
                                            <label class="cm-wrap-tile">
                                                <input type="radio" name="wrap" value="1500" class="sr-only wrap-radio">
                                                <span>ì„ ë¬¼ í¬ì¥ (+1,500ì›)</span>
                                            </label>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right price" th:text="${item.price}">38000</td>
                                <td class="text-center qty" th:text="${item.quantity}">1</td>
                                <td class="text-right subtotal" th:text="${item.subtotal}">38000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ğŸšš ë°°ì†¡ ì •ë³´ -->
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ë°°ì†¡ ì •ë³´</span></h5>
                <div class="cm-card p-3 mb-5">

                    <!-- ì£¼ë¬¸ì -->
                    <h6 class="font-weight-bold mb-3">ì£¼ë¬¸ì ì •ë³´</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="ordererName" name="ordererName"
                                   th:value="${member.name}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="ordererPhone" name="ordererPhone"
                                   th:value="${member.phone}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" class="form-control" id="ordererEmail" name="ordererEmail"
                                   th:value="${member.email}">
                            <small class="form-text text-muted">Dooray ë©”ì‹œì§€ ì „ì†¡ìš©</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- ìˆ˜ë ¹ì¸ -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="font-weight-bold mb-0">ìˆ˜ë ¹ì¸ ì •ë³´</h6>
                        <div>
                            <input type="checkbox" id="sameAsOrderer" class="mr-1">
                            <label for="sameAsOrderer" class="mb-0 small text-muted">ì£¼ë¬¸ì ì •ë³´ì™€ ë™ì¼</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="receiverName" name="receiverName">
                        </div>
                        <div class="form-group col-md-6">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="receiverPhone" name="receiverPhone">
                        </div>
                    </div>

                    <!-- ì£¼ì†Œ -->
                    <div class="form-group">
                        <label>ë°°ì†¡ì§€ ì„ íƒ</label>
                        <select class="custom-select" id="addressSelect" name="addressId" th:if="${addresses != null}">
                            <option value="">ë°°ì†¡ì§€ ì„ íƒ</option>
                            <option th:each="addr : ${addresses}"
                                    th:value="${addr.id}"
                                    th:data-road="${addr.streetName}"
                                    th:data-detail="${addr.detail}"
                                    th:data-postcode="${addr.zipcode}"
                                    th:text="${addr.memo + ' - ' + addr.streetName + ' ' + addr.detail}">
                            </option>
                        </select>
                    </div>

                    <!-- ì§ì ‘ ì…ë ¥ -->
                    <div class="form-group">
                        <label>ì§ì ‘ ì…ë ¥</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="findAddress()">ì£¼ì†Œ ê²€ìƒ‰
                                </button>
                            </div>
                        </div>
                        <input type="text" class="form-control mb-2" id="roadAddress" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>
                        <input type="text" class="form-control" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <textarea class="form-control" name="request" rows="2" placeholder="ì˜ˆ: ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ì¼ ì§€ì •</label>
                        <input type="date" class="form-control" id="deliveryDate" name="deliveryDate"
                               th:value="${defaultDeliveryDate}" th:attr="min=${defaultDeliveryDate}">
                        <small class="text-muted">* ê¸°ë³¸ ë°°ì†¡ì¼ì€ ì£¼ë¬¸ì¼ +3ì¼ì…ë‹ˆë‹¤.</small>
                    </div>
                </div>
            </div>

            <!-- ìš°: ê²°ì œ ì •ë³´ -->
            <div class="col-lg-4 sticky-wrapper">
                <div class="sticky-box">
                    <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ê²°ì œ ì •ë³´</span></h5>
                    <div class="cm-card p-3">
                        <!-- ì„œë²„ì—ì„œ ìƒì„±ëœ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ hiddenìœ¼ë¡œ -->
                        <input type="hidden" name="orderNumber" th:value="${orderNumber}">
                        <input type="hidden" name="orderName" th:value="${orderItems[0].name}">
                        <input type="hidden" name="price" th:value="${summary.payableTotal}">
                        <input type="hidden" name="pointUsed" id="point-used-hidden" th:value="${summary.pointDiscount}">

                        <div class="cm-total-row"><span>ìƒí’ˆ í•©ê³„</span><span id="sum-products" th:text="${summary.productsTotal} + 'ì›'"></span></div>
                        <div class="cm-total-row"><span>ì¿ í° í• ì¸</span><span id="sum-coupon" th:text="'-' + ${summary.couponDiscount} + 'ì›'"></span></div>
                        <div class="cm-total-row"><span>í¬ì¸íŠ¸ ì‚¬ìš©</span><span id="sum-point" th:text="'-' + ${summary.pointDiscount} + 'ì›'"></span></div>
                        <div class="cm-total-row"><span>í¬ì¥ë¹„</span><span id="sum-wrap" th:text="${summary.wrapFeeTotal} + 'ì›'"></span></div>
                        <div class="cm-total-row"><span>ë°°ì†¡ë¹„</span><span id="sum-shipping" th:text="${summary.shippingFee} + 'ì›'"></span></div>
                        <small id="free-shipping-info" class="text-muted d-block mt-1">
                            [[${deliveryPolicy.freeStandardAmount}]]ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡
                        </small>
                        <div class="cm-total-row cm-strong">
                            <span>ì´ ê²°ì œê¸ˆì•¡</span><span id="sum-total" th:text="${summary.payableTotal} + 'ì›'"></span>
                        </div>

                        <button id="openPaymentModal" type="button"
                                class="btn btn-block btn-primary font-weight-bold py-3 mt-3">
                            ê²°ì œí•˜ê¸°
                        </button>

                        <div id="paymentModal" class="modal">
                            <div class="modal-content">
                                <span id="closeModal" class="close">&times;</span>
                                <h5 class="mb-3">ê²°ì œ ì§„í–‰</h5>

                                <div id="payment-method"></div>
                                <div id="agreement" class="mt-3"></div>

<!--                                loading-->
                                <div id="loading" style="display:none; text-align:center; margin-top:1rem;">
                                    <span style="font-size:14px; color:#555;">ê²°ì œ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤... â³</span>
                                </div>

                                <button id="payment-button">ê²°ì œí•˜ê¸°</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </form>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            const policy = {
                freeStandardAmount: /*[[${deliveryPolicy.freeStandardAmount}]]*/,
                deliveryFee: /*[[${deliveryPolicy.deliveryFee}]]*/
            };

            // ìˆ«ì í¬ë§·/íŒŒì‹±
            const fmt = n => (isNaN(n) ? 0 : n).toLocaleString('ko-KR') + 'ì›';
            const num = v => {
                const n = parseInt(String(v).replace(/[^\d-]/g, ''), 10);
                return isNaN(n) ? 0 : n;
            };

            // í•©ê³„ ìƒíƒœ
            const summary = {
                productsTotal: 0,
                couponDiscount: 0,
                pointDiscount: 0,
                wrapFeeTotal: 0,
                shippingFee: policy.deliveryFee
            };

            // DOM í—¬í¼
            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            // í¬ì¸íŠ¸ ì´ ìµœëŒ€ì¹˜(ë³´ìœ  í¬ì¸íŠ¸). í–‰ë§ˆë‹¤ data-maxê°€ ë™ì¼í•˜ë‹¤ê³  ê°€ì •
            const getPointMaxTotal = () => {
                const any = $('.point-input');
                return any ? num(any.dataset.max || 0) : 0;
            };

            // í•©ê³„ ì¬ê³„ì‚°(í•­ìƒ ì „ì²´ë¥¼ ë‹¤ì‹œ ê³„ì‚°)
            const recalc = () => {
                // 1) ìƒí’ˆ ì´í•©: ê° í–‰ì˜ .subtotal í•©
                summary.productsTotal = $$('.subtotal')
                    .map(td => num(td.textContent))
                    .reduce((a, b) => a + b, 0);

                // 2) ì¿ í° í•©ê³„: ì„ íƒëœ ì˜µì…˜ ê°’ë“¤ì˜ í•©
                summary.couponDiscount = $$('.coupon-select')
                    .map(sel => num(sel.value))
                    .reduce((a, b) => a + b, 0);

                // 3) í¬ì¸íŠ¸ í•©ê³„: ê° ì…ë ¥ê°’ í•© -> ì „ì²´ ë³´ìœ í¬ì¸íŠ¸ í•œë„ë¡œ clamp
                const rawPointSum = $$('.point-input')
                    .map(input => num(input.value))
                    .reduce((a, b) => a + b, 0);
                summary.pointDiscount = Math.min(rawPointSum, getPointMaxTotal());

                // 4) í¬ì¥ë¹„: ì„ íƒëœ ë¼ë””ì˜¤ 1ê°œ ê°’
                const checkedWrap = $('.wrap-radio:checked');
                summary.wrapFeeTotal = checkedWrap ? num(checkedWrap.value) : 0;

                // ë°°ì†¡ë¹„ ê³„ì‚°
                summary.shippingFee =
                    summary.productsTotal >= policy.freeStandardAmount
                        ? 0
                        : policy.deliveryFee;

                // 5) ì´ ê²°ì œê¸ˆì•¡
                const total =
                    summary.productsTotal
                    - summary.couponDiscount
                    - summary.pointDiscount
                    + summary.wrapFeeTotal
                    + summary.shippingFee;

                // 6) ì˜¤ë¥¸ìª½ íŒ¨ë„ ë°˜ì˜
                const set = (id, val, prefix = '', sign = '') => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const text = (sign ? sign : '') + fmt(val);
                    el.textContent = prefix ? prefix + text : text;
                };

                // ê°’ ê°±ì‹ 
                $('#sum-products').textContent = fmt(summary.productsTotal);
                $('#sum-coupon').textContent = '-' + fmt(summary.couponDiscount);
                $('#sum-point').textContent = '-' + fmt(summary.pointDiscount);
                $('#sum-wrap').textContent = fmt(summary.wrapFeeTotal);
                $('#sum-shipping').textContent = fmt(summary.shippingFee);
                $('#sum-total').textContent = fmt(total);
                // set('sum-products', summary.productsTotal);
                // set('sum-coupon', summary.couponDiscount, '', '-');
                // set('sum-point', summary.pointDiscount, '', '-');
                // set('sum-wrap', summary.wrapFeeTotal);
                // set('sum-shipping', summary.shippingFee);
                // set('sum-total', total);

                const infoEl = document.getElementById('free-shipping-info');
                if (infoEl) {
                    if (summary.shippingFee === 0) {
                        infoEl.textContent = 'ë¬´ë£Œë°°ì†¡ ì ìš©ë¨ ğŸ‰';
                    } else {
                        infoEl.textContent =
                            policy.freeStandardAmount.toLocaleString() + 'ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡';
                    }
                }
                // 7) í¼ ì „ì†¡ hidden price, point ë™ê¸°í™” (ìµœì¢… ê²°ì œê¸ˆì•¡ ìˆ«ì)
                const priceHidden = $('input[name="price"]');
                if (priceHidden) priceHidden.value = total;

                const pointUsedHidden = $('input[name="pointUsed"]');
                if (pointUsedHidden) pointUsedHidden.value = summary.pointDiscount;
            };

            // ì´ë²¤íŠ¸ ë°”ì¸ë”© ----------------------------

            // ì£¼ë¬¸ì ë™ì¼ ì²´í¬ -> ìˆ˜ë ¹ì¸ ë³µì‚¬
            const sameCheck = $('#sameAsOrderer');
            if (sameCheck) {
                sameCheck.addEventListener('change', e => {
                    const on = e.target.checked;
                    $('#receiverName').value  = on ? ($('#ordererName').value  || '') : '';
                    $('#receiverPhone').value = on ? ($('#ordererPhone').value || '') : '';
                });
            }

            // ë°°ì†¡ì¼ min = ì˜¤ëŠ˜ +3
            const deliveryDate = $('#deliveryDate');
            if (deliveryDate) {
                const today = new Date();
                today.setDate(today.getDate() + 3);
                deliveryDate.min = today.toISOString().split('T')[0];
                if (!deliveryDate.value) deliveryDate.value = deliveryDate.min;
            }

            // ë°°ì†¡ì§€ ì„ íƒ ì‹œ ìë™ ì±„ìš°ê¸°
            const addressSelect = document.getElementById("addressSelect");
            if (addressSelect) {
                addressSelect.addEventListener("change", (e) => {
                    const selected = e.target.selectedOptions[0];
                    if (!selected) return;

                    const postcode = selected.dataset.postcode || "";
                    const road = selected.dataset.road || "";
                    const detail = selected.dataset.detail || "";

                    // í¼ì— ë°˜ì˜
                    document.getElementById("postcode").value = postcode;
                    document.getElementById("roadAddress").value = road;
                    document.getElementById("detailAddress").value = detail;

                    console.log("[ë°°ì†¡ì§€ ì„ íƒ]", { postcode, road, detail });
                });
            }

            // ì£¼ì†Œ ê²€ìƒ‰
            window.findAddress = function() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        // ì£¼ìš” ë°ì´í„° ì¶”ì¶œ
                        const roadAddr = data.roadAddress;    // ë„ë¡œëª… ì£¼ì†Œ
                        const jibunAddr = data.jibunAddress;  // ì§€ë²ˆ ì£¼ì†Œ
                        const zonecode = data.zonecode;       // ìš°í¸ë²ˆí˜¸
                        const buildingName = data.buildingName || '';

                        // ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
                        document.getElementById("postcode").value = zonecode;
                        document.getElementById("roadAddress").value = roadAddr;

                        // ìƒì„¸ ì£¼ì†Œ ì…ë ¥ì¹¸ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                        document.getElementById("detailAddress").focus();

                        const detailInput = document.getElementById("detailAddress");
                        if (detailInput) {
                            detailInput.value = "";     // ê¸°ì¡´ ê°’ ì œê±°
                            detailInput.focus();        // ì»¤ì„œ ì´ë™
                        }

                        const select = document.getElementById("addressSelect");
                        if (select) {
                            select.value = "";
                        }

                        // ì½˜ì†” í™•ì¸ìš©
                        console.log("ì„ íƒëœ ì£¼ì†Œ:", {
                            ë„ë¡œëª…ì£¼ì†Œ: roadAddr,
                            ì§€ë²ˆì£¼ì†Œ: jibunAddr,
                            ê±´ë¬¼ëª…: buildingName,
                            ìš°í¸ë²ˆí˜¸: zonecode
                        });
                    }
                }).open();
            };

            // ì¿ í° ë³€ê²½ -> ì¬ê³„ì‚°
            $$('.coupon-select').forEach(sel => {
                sel.addEventListener('change', recalc);
            });

            // í¬ì¸íŠ¸ ì…ë ¥ -> ìˆ«ì ì •ê·œí™” í›„ ì¬ê³„ì‚°
            $$('.point-input').forEach(input => {
                input.addEventListener('input', () => {
                    input.value = String(num(input.value)); // ìˆ«ìë§Œ ìœ ì§€
                    recalc();
                });
            });

            // í¬ì¥ì§€ ë¼ë””ì˜¤ -> ì¬ê³„ì‚°
            $$('.wrap-radio').forEach(r => {
                r.addEventListener('change', recalc);
            });

            // í¬ì¸íŠ¸ ìµœëŒ€ ë²„íŠ¼
            window.useMaxPoint = (btn) => {
                const input = btn.closest('.input-group')?.querySelector('.point-input');
                if (!input) return;
                const max = getPointMaxTotal();

                // í˜„ì¬ ë‹¤ë¥¸ í–‰ì—ì„œ ì´ë¯¸ ì…ë ¥í•œ í¬ì¸íŠ¸ í•©
                const others = $$('.point-input')
                    .filter(i => i !== input)
                    .map(i => num(i.value))
                    .reduce((a, b) => a + b, 0);

                // ë‚¨ì€ í•œë„ë§Œí¼ í˜„ì¬ ì…ë ¥ì°½ì— ì„¸íŒ…
                const remain = Math.max(0, max - others);
                input.value = remain;
                recalc();
            };

            // ì´ˆê¸° 1íšŒ ê³„ì‚°
            recalc();

            // í¼ ì œì¶œ ì‹œ ì•ˆì „ ì¥ì¹˜: ìµœì¢…ê¸ˆì•¡ ë‹¤ì‹œ ë™ê¸°í™”
            const form = document.getElementById('checkoutForm');
            if (form) {
                form.addEventListener('submit', () => {
                    recalc();
                });
            }

            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);

            const modal = document.getElementById("paymentModal");
            const openBtn = document.getElementById("openPaymentModal");
            const closeBtn = document.getElementById("closeModal");
            const confirmBtn = document.getElementById("payment-button");

            openBtn.addEventListener("click", async (event) => {
                event.preventDefault();
                modal.style.display = "block";

                // ìµœì‹  ê³„ì‚° ë°˜ì˜ (orderPageì˜ recalc() í˜¸ì¶œ)
                if (typeof recalc === "function") recalc();

                const orderId = document.querySelector("input[name='orderNumber']").value;
                const orderName = document.querySelector("input[name='orderName']").value;
                const totalAmount = parseInt(document.querySelector("input[name='price']").value);
                const pointUsed = parseInt(document.querySelector("input[name='pointUsed']").value || 0);
                const tossAmount = totalAmount - pointUsed;

                // âœ… [ì¶”ê°€] ê²°ì œê¸ˆì•¡ì´ 0ì›(ì „ì•¡ í¬ì¸íŠ¸ ê²°ì œ)ì´ë©´ Toss ìƒëµ â†’ ë°”ë¡œ success í˜ì´ì§€ë¡œ ì´ë™
                if (tossAmount <= 0) {
                    console.log("[í¬ì¸íŠ¸ ê²°ì œ ê°ì§€] Toss ëª¨ë‹¬ ìƒëµ â†’ ë°”ë¡œ success ì´ë™");
                    window.location.href =
                        `/payments/success?orderId=${orderId}&amount=${totalAmount}&pointUsed=${pointUsed}`;
                    return;
                }

                const widgets = tossPayments.widgets({ customerKey: orderId });

                await widgets.setAmount({ currency: "KRW", value: tossAmount });
                await widgets.renderPaymentMethods({
                    selector: "#payment-method",
                    variantKey: "DEFAULT",
                });
                await widgets.renderAgreement({
                    selector: "#agreement",
                    variantKey: "AGREEMENT",
                });

                confirmBtn.onclick = async function () {
                    const loading = document.getElementById("loading");
                    loading.style.display = "block"; // ë¡œë”© í‘œì‹œ

                    try {
                        await widgets.requestPayment({
                            orderId: orderId,
                            orderName: orderName,
                            successUrl: window.location.origin + "/payments/success",
                            failUrl: window.location.origin + "/payments/fail",
                        });
                    } catch (err) {
                        loading.style.display = "none"; // ì‹¤íŒ¨ ì‹œ ìˆ¨ê¹€
                        alert("ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        console.error(err);
                    }
                };
            });

            // ëª¨ë‹¬ ë‹«ê¸°
            closeBtn.addEventListener("click", () => {
                modal.style.display = "none";
                alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        });
    </script>

</section>
</html>
