<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<head>
    <meta charset="UTF-8"/>
    <title>Ï£ºÎ¨∏ÏÑú | Chaekmate</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<section>
    <style>
        /* ------- Í≥µÌÜµ Ïπ¥Îìú Ïä§ÌÉÄÏùº ------- */
        .cm-card {
            background: var(--light);
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: .25rem;
        }

        .cm-section-title {
            position: relative;
            display: inline-block;
            padding: .25rem .75rem;
            background: var(--secondary);
            color: var(--dark);
            text-transform: uppercase;
        }

        .cm-total-row {
            display: flex;
            justify-content: space-between;
            padding: .25rem 0;
        }

        .cm-total-row.cm-strong {
            border-top: 1px solid rgba(0, 0, 0, .1);
            margin-top: .5rem;
            padding-top: .75rem;
            font-weight: 600;
        }

        .cm-wrap-tile {
            border: 1px solid rgba(0, 0, 0, .08);
            border-radius: .25rem;
            padding: .5rem;
            cursor: pointer;
        }

        .cm-wrap-tile.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 211, 51, .25);
        }

        @media (min-width: 992px) {
            .sticky-box {
                position: sticky;
                top: 100px;
            }
        }

        .sticky-wrapper {
            position: relative;
        }
    </style>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/">Ìôà</a>
                    <a class="breadcrumb-item text-dark" href="/shop">ÏÑúÏ†ê</a>
                    <span class="breadcrumb-item active">Ï£ºÎ¨∏ÏÑú</span>
                </nav>
            </div>
        </div>
    </div>

    <form id="checkoutForm" class="container-fluid" method="post">
        <div class="row px-xl-5">
            <!-- Ï¢åÏ∏°: Ï£ºÎ¨∏ ÏÉÅÌíà -->
            <div class="col-lg-8">
                <h5 class="section-title text-uppercase mb-3">
                    <span class="cm-section-title">Ï£ºÎ¨∏ ÏÉÅÌíà</span>
                </h5>
                <div class="cm-card p-3 mb-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead>
                            <tr class="text-dark">
                                <th style="width:64px">ÌëúÏßÄ</th>
                                <th>ÏÉÅÌíàÎ™Ö</th>
                                <th class="text-right">Í∞ÄÍ≤©</th>
                                <th class="text-center">ÏàòÎüâ</th>
                                <th class="text-right">ÏÜåÍ≥Ñ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item,idx : ${orderItems}">
                                <td><img th:src="@{${item.thumbnailUrl}}" class="img-fluid rounded"
                                         style="max-width:48px;"></td>
                                <td>
                                    <div class="font-weight-bold" th:text="${item.name}">Ï±Ö Ï†úÎ™©</div>
                                    <small class="text-muted d-block" th:text="${item.author}">Ï†ÄÏûê</small>

                                    <!-- Ïø†Ìè∞ -->
                                    <div class="mt-2">
                                        <label class="mb-1 d-block">Ïø†Ìè∞ Ï†ÅÏö©</label>
                                        <select class="custom-select coupon-select" th:data-price="${item.price}">
                                            <option value="">ÏÑ†ÌÉù ÏïàÌï®</option>
                                            <option value="3000">3,000Ïõê Ìï†Ïù∏ Ïø†Ìè∞</option>
                                            <option value="5000">5,000Ïõê Ìï†Ïù∏ Ïø†Ìè∞</option>
                                        </select>
                                    </div>

                                    <!-- Ìè¨Ïù∏Ìä∏ -->
                                    <div class="mt-2">
                                        <label class="mb-1">Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïö©</label>
                                        <div class="input-group">
                                            <input type="number" min="0" class="form-control point-input"
                                                   placeholder="ÏÇ¨Ïö© Ìè¨Ïù∏Ìä∏ ÏûÖÎ†•" th:data-max="${member.remainingPoints}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="useMaxPoint(this)">ÏµúÎåÄ
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted">Î≥¥Ïú† Ìè¨Ïù∏Ìä∏: <b
                                                th:text="${member.remainingPoints}">12000</b>P</small>
                                    </div>

                                    <!-- Ìè¨Ïû•ÏßÄ -->
                                    <div class="mt-3">
                                        <label class="mb-1 d-block">Ìè¨Ïû•ÏßÄ ÏÑ†ÌÉù</label>
                                        <div class="d-flex">
                                            <label class="cm-wrap-tile mr-2">
                                                <input type="radio" name="wrap" value="0" class="sr-only wrap-radio">
                                                <span>Í∏∞Î≥∏ (Î¨¥Î£å)</span>
                                            </label>
                                            <label class="cm-wrap-tile">
                                                <input type="radio" name="wrap" value="1500" class="sr-only wrap-radio">
                                                <span>ÏÑ†Î¨º Ìè¨Ïû• (+1,500Ïõê)</span>
                                            </label>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right price" th:text="${item.price}">38000</td>
                                <td class="text-center qty" th:text="${item.quantity}">1</td>
                                <td class="text-right subtotal" th:text="${item.subtotal}">38000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- üöö Î∞∞ÏÜ° Ï†ïÎ≥¥ -->
                <h5 class="section-title text-uppercase mb-3">
                    <span class="cm-section-title">Î∞∞ÏÜ° Ï†ïÎ≥¥</span>
                </h5>
                <div class="cm-card p-3 mb-5">
                    <!-- Ï£ºÎ¨∏Ïûê -->
                    <h6 class="font-weight-bold mb-3">Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Ïù¥Î¶Ñ</label>
                            <input type="text" class="form-control" id="ordererName" name="ordererName"
                                   th:value="${member.name}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Ï†ÑÌôîÎ≤àÌò∏</label>
                            <input type="text" class="form-control" id="ordererPhone" name="ordererPhone"
                                   th:value="${member.phone}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Ïù¥Î©îÏùº</label>
                            <input type="email" class="form-control" id="ordererEmail" name="ordererEmail"
                                   th:value="${member.email}">
                            <small class="form-text text-muted">Dooray Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïö©</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- ÏàòÎ†πÏù∏ -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="font-weight-bold mb-0">ÏàòÎ†πÏù∏ Ï†ïÎ≥¥</h6>
                        <div>
                            <input type="checkbox" id="sameAsOrderer" class="mr-1">
                            <label for="sameAsOrderer" class="mb-0 small text-muted">Ï£ºÎ¨∏Ïûê Ï†ïÎ≥¥ÏôÄ ÎèôÏùº</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Ïù¥Î¶Ñ</label>
                            <input type="text" class="form-control" id="receiverName" name="receiverName">
                        </div>
                        <div class="form-group col-md-6">
                            <label>Ï†ÑÌôîÎ≤àÌò∏</label>
                            <input type="text" class="form-control" id="receiverPhone" name="receiverPhone">
                        </div>
                    </div>

                    <!-- Ï£ºÏÜå -->
                    <div class="form-group">
                        <label>Î∞∞ÏÜ°ÏßÄ ÏÑ†ÌÉù</label>
                        <select class="custom-select" id="addressSelect" name="addressId" th:if="${addresses != null}">
                            <option value="">Î∞∞ÏÜ°ÏßÄ ÏÑ†ÌÉù</option>
                            <option th:each="addr : ${addresses}" th:value="${addr.id}"
                                    th:text="${addr.label + ' - ' + addr.road + ' ' + addr.detail}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ÏßÅÏ†ë ÏûÖÎ†•</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="postcode" placeholder="Ïö∞Ìé∏Î≤àÌò∏" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="findAddress()">Ï£ºÏÜå Í≤ÄÏÉâ
                                </button>
                            </div>
                        </div>
                        <input type="text" class="form-control mb-2" id="roadAddress" placeholder="ÎèÑÎ°úÎ™Ö Ï£ºÏÜå" readonly>
                        <input type="text" class="form-control" id="detailAddress" placeholder="ÏÉÅÏÑ∏ Ï£ºÏÜå ÏûÖÎ†•">
                    </div>

                    <div class="form-group">
                        <label>Î∞∞ÏÜ° ÏöîÏ≤≠ÏÇ¨Ìï≠</label>
                        <textarea class="form-control" name="request" rows="2" placeholder="Ïòà: Î¨∏ ÏïûÏóê ÎÜìÏïÑÏ£ºÏÑ∏Ïöî."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Î∞∞ÏÜ°Ïùº ÏßÄÏ†ï</label>
                        <input type="date" class="form-control" id="deliveryDate" name="deliveryDate"
                               th:value="${defaultDeliveryDate}" th:attr="min=${defaultDeliveryDate}">
                        <small class="text-muted">* Í∏∞Î≥∏ Î∞∞ÏÜ°ÏùºÏùÄ Ï£ºÎ¨∏Ïùº +3ÏùºÏûÖÎãàÎã§.</small>
                    </div>
                </div>
            </div>

            <!-- Ïö∞: Í≤∞Ï†ú Ï†ïÎ≥¥ -->
            <div class="col-lg-4 sticky-wrapper">
                <div class="sticky-box">
                    <h5 class="section-title text-uppercase mb-3">
                        <span class="cm-section-title">Í≤∞Ï†ú Ï†ïÎ≥¥</span>
                    </h5>
                    <div class="cm-card p-3">
                        <input type="hidden" name="orderNumber" th:value="${orderNumber}">
                        <input type="hidden" name="orderName" th:value="${orderItems[0].name}">
                        <input type="hidden" name="price" th:value="${summary.payableTotal}">

                        <div class="cm-total-row"><span>ÏÉÅÌíà Ìï©Í≥Ñ</span><span id="sum-products"
                                                                          th:text="${summary.productsTotal} + 'Ïõê'"></span>
                        </div>
                        <div class="cm-total-row"><span>Ïø†Ìè∞ Ìï†Ïù∏</span><span id="sum-coupon"
                                                                          th:text="'-' + ${summary.couponDiscount} + 'Ïõê'"></span>
                        </div>
                        <div class="cm-total-row"><span>Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïö©</span><span id="sum-point"
                                                                           th:text="'-' + ${summary.pointDiscount} + 'Ïõê'"></span>
                        </div>
                        <div class="cm-total-row"><span>Ìè¨Ïû•ÎπÑ</span><span id="sum-wrap"
                                                                        th:text="${summary.wrapFeeTotal} + 'Ïõê'"></span>
                        </div>
                        <div class="cm-total-row"><span>Î∞∞ÏÜ°ÎπÑ</span><span id="sum-shipping"
                                                                        th:text="${summary.shippingFee} + 'Ïõê'"></span>
                        </div>
                        <div class="cm-total-row cm-strong">
                            <span>Ï¥ù Í≤∞Ï†úÍ∏àÏï°</span><span id="sum-total" th:text="${summary.payableTotal} + 'Ïõê'"></span>
                        </div>

                        <div id="payment-method" style="margin-top: 20px;"></div>
                        <div id="agreement" style="margin-top: 10px;"></div>
                        <button id="payment-button" type="button"
                                class="btn btn-block btn-primary font-weight-bold py-3 mt-3">
                            Í≤∞Ï†úÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
        <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                                         background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center;">
            <div style="font-size:1.2rem;">Í≤∞Ï†ú ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§...</div>
        </div>
    </form>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', async () => {
            const orderId = '[[${orderNumber}]]';
            const orderName = '[[${orderName}]]';
            const amount = '[[${price}]]';
            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);
            const overlay = document.getElementById("loading-overlay");

            try {
                const widgets = tossPayments.widgets({ customerKey: orderId });
                await widgets.setAmount({ currency: "KRW", value: amount });
                await widgets.renderPaymentMethods({ selector: "#payment-method" });
                await widgets.renderAgreement({ selector: "#agreement" });

                document.getElementById("payment-button").addEventListener("click", async () => {
                    overlay.style.display = "flex";
                    try {
                        await widgets.requestPayment({
                            orderId: orderId,
                            orderName: orderName,
                            successUrl: window.location.origin + "/payments/success",
                            failUrl: window.location.origin + "/payments/fail"
                        });
                    } catch (error) {
                        overlay.style.display = "none";
                        if (error.code === "USER_CANCEL") {
                            alert("Í≤∞Ï†úÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.");
                        } else {
                            alert("Í≤∞Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                            console.error(error);
                        }
                    }
                });
            } catch (e) {
                console.error("Toss ÏúÑÏ†Ø Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", e);
                alert("Í≤∞Ï†ú ÏúÑÏ†Ø Î°úÎìú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            }

            // ==================== Ï£ºÎ¨∏ Í∏àÏï° Í≥ÑÏÇ∞ ==================== //
            const fmt = n => (isNaN(n) ? 0 : n).toLocaleString('ko-KR') + 'Ïõê';
            const num = v => {
                const n = parseInt(String(v).replace(/[^\d-]/g, ''), 10);
                return isNaN(n) ? 0 : n;
            };

            const summary = {
                productsTotal: 0,
                couponDiscount: 0,
                pointDiscount: 0,
                wrapFeeTotal: 0,
                shippingFee: 3000
            };

            const $ = (sel, root = document) => root.querySelector(sel);
            const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

            const getPointMaxTotal = () => {
                const any = $('.point-input');
                return any ? num(any.dataset.max || 0) : 0;
            };

            const recalc = () => {
                summary.productsTotal = $$('.subtotal')
                    .map(td => num(td.textContent))
                    .reduce((a, b) => a + b, 0);

                summary.couponDiscount = $$('.coupon-select')
                    .map(sel => num(sel.value))
                    .reduce((a, b) => a + b, 0);

                const rawPointSum = $$('.point-input')
                    .map(input => num(input.value))
                    .reduce((a, b) => a + b, 0);
                summary.pointDiscount = Math.min(rawPointSum, getPointMaxTotal());

                const checkedWrap = $('.wrap-radio:checked');
                summary.wrapFeeTotal = checkedWrap ? num(checkedWrap.value) : 0;

                const total =
                    summary.productsTotal
                    - summary.couponDiscount
                    - summary.pointDiscount
                    + summary.wrapFeeTotal
                    + summary.shippingFee;

                const set = (id, val, prefix = '', sign = '') => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const text = (sign ? sign : '') + fmt(val);
                    el.textContent = prefix ? prefix + text : text;
                };

                set('sum-products', summary.productsTotal);
                set('sum-coupon', summary.couponDiscount, '', '-');
                set('sum-point', summary.pointDiscount, '', '-');
                set('sum-wrap', summary.wrapFeeTotal);
                set('sum-shipping', summary.shippingFee);
                set('sum-total', total);

                const priceHidden = $('input[name="price"]');
                if (priceHidden) priceHidden.value = total;
            };

            // Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
            const sameCheck = $('#sameAsOrderer');
            if (sameCheck) {
                sameCheck.addEventListener('change', e => {
                    const on = e.target.checked;
                    $('#receiverName').value = on ? ($('#ordererName').value || '') : '';
                    $('#receiverPhone').value = on ? ($('#ordererPhone').value || '') : '';
                });
            }

            const deliveryDate = $('#deliveryDate');
            if (deliveryDate) {
                const today = new Date();
                today.setDate(today.getDate() + 3);
                deliveryDate.min = today.toISOString().split('T')[0];
                if (!deliveryDate.value) deliveryDate.value = deliveryDate.min;
            }

            window.findAddress = function () {
                new daum.Postcode({
                    oncomplete: function (data) {
                        // ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï£ºÏöî Ï†ïÎ≥¥ Ï∂îÏ∂ú
                        const roadAddr = data.roadAddress; // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå
                        const jibunAddr = data.jibunAddress; // ÏßÄÎ≤à Ï£ºÏÜå (Ï∞∏Í≥†Ïö©)
                        const zonecode = data.zonecode; // Ïö∞Ìé∏Î≤àÌò∏
                        const buildingName = data.buildingName || ''; // Í±¥Î¨ºÎ™Ö

                        // ÌèºÏóê Ï±ÑÏö∞Í∏∞
                        document.getElementById("postcode").value = zonecode;
                        document.getElementById("roadAddress").value = roadAddr;

                        // ÏÉÅÏÑ∏Ï£ºÏÜåÎ°ú Ìè¨Ïª§Ïä§
                        document.getElementById("detailAddress").focus();

                        // Ï∞∏Í≥† Ï†ïÎ≥¥ ÏΩòÏÜî ÌôïÏù∏Ïö© (ÌïÑÏöî Ïãú Ï†úÍ±∞)
                        console.log("ÏÑ†ÌÉùÎêú Ï£ºÏÜå:", {
                            ÎèÑÎ°úÎ™ÖÏ£ºÏÜå: roadAddr,
                            ÏßÄÎ≤àÏ£ºÏÜå: jibunAddr,
                            Í±¥Î¨ºÎ™Ö: buildingName,
                            Ïö∞Ìé∏Î≤àÌò∏: zonecode
                        });
                    },
                    width: '100%',
                    height: '100%'
                }).open();
            };


            $$('.coupon-select').forEach(sel => sel.addEventListener('change', recalc));
            $$('.point-input').forEach(input => {
                input.addEventListener('input', () => {
                    input.value = String(num(input.value));
                    recalc();
                });
            });
            $$('.wrap-radio').forEach(r => r.addEventListener('change', recalc));

            window.useMaxPoint = (btn) => {
                const input = btn.closest('.input-group')?.querySelector('.point-input');
                if (!input) return;
                const max = getPointMaxTotal();
                const others = $$('.point-input')
                    .filter(i => i !== input)
                    .map(i => num(i.value))
                    .reduce((a, b) => a + b, 0);
                const remain = Math.max(0, max - others);
                input.value = remain;
                recalc();
            };

            recalc();

            // Ìèº Ï†úÏ∂ú Ïãú ÏïàÏ†Ñ Ïû•Ïπò: ÏµúÏ¢ÖÍ∏àÏï° Îã§Ïãú ÎèôÍ∏∞Ìôî
            const form = document.getElementById('checkoutForm');
            if (form) {
                form.addEventListener('submit', () => {
                    recalc();
                });
            }
        });
    </script>

</section>
</html>
