<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">

<section>
    <link rel="stylesheet" th:href="@{/css/order.css}"/>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://js.tosspayments.com/v2/standard"></script>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/">í™ˆ</a>
                    <a class="breadcrumb-item text-dark" href="/shop">ì„œì </a>
                    <span class="breadcrumb-item active">ì£¼ë¬¸ì„œ</span>
                </nav>
            </div>
        </div>
    </div>

    <form id="checkoutForm" class="container-fluid">
        <div class="row px-xl-5">
            <!-- ì¢Œì¸¡: ì£¼ë¬¸ ìƒí’ˆ -->
            <div class="col-lg-8">
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ì£¼ë¬¸ ìƒí’ˆ</span></h5>
                <div class="cm-card p-3 mb-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead>
                            <tr class="text-dark">
                                <th style="width:64px">í‘œì§€</th>
                                <th>ìƒí’ˆëª…</th>
                                <th class="text-right">ê°€ê²©</th>
                                <th class="text-center">ìˆ˜ëŸ‰</th>
                                <th class="text-right">ì†Œê³„</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item,idx : ${orderItems}">
                                <td><img th:src="@{${item.thumbnailUrl}}" class="img-fluid rounded"
                                         style="max-width:48px;"></td>
                                <td>
                                    <div class="font-weight-bold" th:text="${item.name}">ì±… ì œëª©</div>
                                    <small class="text-muted d-block" th:text="${item.author}">ì €ì</small>

                                    <!-- ì¿ í° -->
                                    <div class="mt-2">
                                        <label class="mb-1 d-block">ì¿ í° ì ìš©</label>
                                        <select class="custom-select coupon-select" th:data-price="${item.price}">
                                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                                            <option value="3000">3,000ì› í• ì¸ ì¿ í°</option>
                                            <option value="5000">5,000ì› í• ì¸ ì¿ í°</option>
                                        </select>
                                    </div>

                                    <!-- í¬ì¸íŠ¸ -->
                                    <div class="mt-2">
                                        <label class="mb-1">í¬ì¸íŠ¸ ì‚¬ìš©</label>
                                        <div class="input-group">
                                            <input type="number" min="0" class="form-control point-input"
                                                   placeholder="ì‚¬ìš© í¬ì¸íŠ¸ ì…ë ¥" th:data-max="${member.remainingPoints}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="useMaxPoint(this)">ìµœëŒ€
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted">ë³´ìœ  í¬ì¸íŠ¸: <b
                                                th:text="${member.remainingPoints}">18000</b>P</small>
                                    </div>

                                    <!-- í¬ì¥ì§€ -->
                                    <div class="mt-3">
                                        <label class="mb-1 d-block">í¬ì¥ì§€ ì„ íƒ</label>
                                        <div class="d-flex">
                                            <label class="cm-wrap-tile mr-2">
                                                <input type="radio" name="wrap" value="0" class="sr-only wrap-radio">
                                                <span>ê¸°ë³¸ (ë¬´ë£Œ)</span>
                                            </label>
                                            <label class="cm-wrap-tile">
                                                <input type="radio" name="wrap" value="1500" class="sr-only wrap-radio">
                                                <span>ì„ ë¬¼ í¬ì¥ (+1,500ì›)</span>
                                            </label>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right price" th:text="${item.price}">38000</td>
                                <td class="text-center qty" th:text="${item.quantity}">1</td>
                                <td class="text-right subtotal" th:text="${item.subtotal}">38000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ğŸšš ë°°ì†¡ ì •ë³´ -->
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ë°°ì†¡ ì •ë³´</span></h5>
                <div class="cm-card p-3 mb-5">

                    <!-- ì£¼ë¬¸ì -->
                    <h6 class="font-weight-bold mb-3">ì£¼ë¬¸ì ì •ë³´</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="ordererName" name="ordererName"
                                   th:value="${member.name}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="ordererPhone" name="ordererPhone"
                                   th:value="${member.phone}">
                        </div>
                        <div class="form-group col-md-4">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" class="form-control" id="ordererEmail" name="ordererEmail"
                                   th:value="${member.email}">
                            <small class="form-text text-muted">* Dooray ë©”ì‹œì§€ ì „ì†¡ìš©</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- ìˆ˜ë ¹ì¸ -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="font-weight-bold mb-0">ìˆ˜ë ¹ì¸ ì •ë³´</h6>
                        <div>
                            <input type="checkbox" id="sameAsOrderer" class="mr-1">
                            <label for="sameAsOrderer" class="mb-0 small text-muted">ì£¼ë¬¸ì ì •ë³´ì™€ ë™ì¼</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>ì´ë¦„</label>
                            <input type="text" class="form-control" id="receiverName" name="receiverName">
                        </div>
                        <div class="form-group col-md-6">
                            <label>ì „í™”ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="receiverPhone" name="receiverPhone">
                        </div>
                    </div>

                    <!-- ì£¼ì†Œ -->
                    <div class="form-group">
                        <label>ë°°ì†¡ì§€ ì„ íƒ</label>
                        <select class="custom-select" id="addressSelect" name="addressId" th:if="${addresses != null}">
                            <option value="">ë°°ì†¡ì§€ ì„ íƒ</option>
                            <option th:each="addr : ${addresses}"
                                    th:value="${addr.id}"
                                    th:data-road="${addr.streetName}"
                                    th:data-detail="${addr.detail}"
                                    th:data-postcode="${addr.zipcode}"
                                    th:text="${addr.memo + ' - ' + addr.streetName + ' ' + addr.detail}">
                            </option>
                        </select>
                    </div>

                    <!-- ì§ì ‘ ì…ë ¥ -->
                    <div class="form-group">
                        <label>ì§ì ‘ ì…ë ¥</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-secondary" onclick="findAddress()">ì£¼ì†Œ ê²€ìƒ‰
                                </button>
                            </div>
                        </div>
                        <input type="text" class="form-control mb-2" id="roadAddress" placeholder="ë„ë¡œëª… ì£¼ì†Œ" readonly>
                        <input type="text" class="form-control" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œ ì…ë ¥">
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
                        <textarea class="form-control" name="request" rows="2" placeholder="ì˜ˆ: ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ë°°ì†¡ì¼ ì§€ì •</label>
                        <input type="date" class="form-control" id="deliveryDate" name="deliveryDate"
                               th:value="${defaultDeliveryDate}" th:attr="min=${defaultDeliveryDate}">
                        <small class="text-muted">* ê¸°ë³¸ ë°°ì†¡ì¼ì€ ì£¼ë¬¸ì¼ +3ì¼ì…ë‹ˆë‹¤.</small>
                    </div>
                </div>
            </div>

            <!-- ìš°: ê²°ì œ ì •ë³´ -->
            <div class="col-lg-4 sticky-wrapper">
                <div class="sticky-box">
                    <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">ê²°ì œ ì •ë³´</span></h5>
                    <div class="cm-card p-3">
                        <!-- ì„œë²„ì—ì„œ ìƒì„±ëœ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ hiddenìœ¼ë¡œ -->
                        <input type="hidden" id="orderNumber" name="orderNumber" th:value="${orderNumber}">
                        <input type="hidden" id="orderName" name="orderName" th:value="${orderItems[0].name}">
                        <input type="hidden" id="price" name="price" th:value="${summary.payableTotal}">
                        <input type="hidden" id="pointUsed" th:value="${summary.pointDiscount}">


                        <div class="cm-total-row"><span>ìƒí’ˆ í•©ê³„</span><span id="sum-products"
                                                                          th:text="${summary.productsTotal} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>ì¿ í° í• ì¸</span><span id="sum-coupon"
                                                                          th:text="'-' + ${summary.couponDiscount} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>í¬ì¸íŠ¸ ì‚¬ìš©</span><span id="sum-point"
                                                                           th:text="'-' + ${summary.pointDiscount} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>í¬ì¥ë¹„</span><span id="sum-wrap"
                                                                        th:text="${summary.wrapFeeTotal} + 'ì›'"></span>
                        </div>
                        <div class="cm-total-row"><span>ë°°ì†¡ë¹„</span><span id="sum-shipping"
                                                                        th:text="${summary.shippingFee} + 'ì›'"></span>
                        </div>
                        <small id="free-shipping-info" class="text-muted d-block mt-1">
                            [[${deliveryPolicy.freeStandardAmount}]]ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡
                        </small>
                        <div class="cm-total-row cm-strong">
                            <span>ì´ ê²°ì œê¸ˆì•¡</span><span id="sum-total" th:text="${summary.payableTotal} + 'ì›'"></span>
                        </div>

                        <button type="submit" class="btn btn-block btn-primary font-weight-bold py-3 mt-3">
                            ê²°ì œí•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- ê²°ì œ ëª¨ë‹¬ -->
    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <h4>ê²°ì œ ì§„í–‰</h4>
            <!-- ê²°ì œ ìˆ˜ë‹¨ UI -->
            <div id="payment-method"></div>
            <!-- ì•½ê´€ UI -->
            <div id="agreement" class="mt-3"></div>
            <!-- ê²°ì œ ë²„íŠ¼ -->
            <button id="payButton" class="btn btn-primary btn-block mt-4">ê²°ì œí•˜ê¸°</button>
            <!-- ì·¨ì†Œ ë²„íŠ¼ -->
            <button id="cancelModalBtn" class="btn btn-outline-secondary btn-block mt-2">ë‹«ê¸°</button>
        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', () => {
            // ë°°ì†¡ ì •ì±…
            const policy = {
                freeStandardAmount: /*[[${deliveryPolicy.freeStandardAmount}]]*/,
                deliveryFee: /*[[${deliveryPolicy.deliveryFee}]]*/
            };

            // ìˆ«ì í¬ë§·/íŒŒì‹±
            const fmt = n => (isNaN(n) ? 0 : n).toLocaleString('ko-KR') + 'ì›';
            const num = v => {
                const n = parseInt(String(v).replace(/[^\d-]/g, ''), 10);
                return isNaN(n) ? 0 : n;
            };

            // í•©ê³„ ìƒíƒœ
            const summary = {
                productsTotal: 0,
                couponDiscount: 0,
                pointDiscount: 0,
                wrapFeeTotal: 0,
                shippingFee: policy.deliveryFee
            };

            // DOM í—¬í¼
            const $ = (sel) => document.querySelector(sel);
            const $$ = (sel) => Array.from(document.querySelectorAll(sel));

            // ë³´ìœ  í¬ì¸íŠ¸ ìµœëŒ€ê°’ (member.remainingPoints)
            const getPointMaxTotal = () => {
                const any = $('.point-input');
                return any ? num(any.dataset.max || 0) : 0;
            };

            // í•©ê³„ ì¬ê³„ì‚°
            const recalc = () => {
                // 1) ìƒí’ˆ ì´í•©
                summary.productsTotal = $$('.subtotal')
                    .map(td => num(td.textContent))
                    .reduce((a, b) => a + b, 0);

                // 2) ì¿ í° í•©ê³„
                summary.couponDiscount = $$('.coupon-select')
                    .map(sel => num(sel.value))
                    .reduce((a, b) => a + b, 0);

                // 3) í¬ì¸íŠ¸ í•©ê³„ (ì „ì²´ ë³´ìœ  í¬ì¸íŠ¸ í•œë„ë¡œ ì œí•œ)
                const rawPointSum = $$('.point-input')
                    .map(input => num(input.value))
                    .reduce((a, b) => a + b, 0);
                summary.pointDiscount = Math.min(rawPointSum, getPointMaxTotal());

                // 4) í¬ì¥ë¹„
                const checkedWrap = $('.wrap-radio:checked');
                summary.wrapFeeTotal = checkedWrap ? num(checkedWrap.value) : 0;

                // 5) ë°°ì†¡ë¹„ (ë¬´ë£Œë°°ì†¡ ì¡°ê±´ ì²´í¬)
                summary.shippingFee =
                    summary.productsTotal >= policy.freeStandardAmount
                        ? 0
                        : policy.deliveryFee;

                // 6) ì´ ê²°ì œê¸ˆì•¡
                const total =
                    summary.productsTotal
                    - summary.couponDiscount
                    - summary.pointDiscount
                    + summary.wrapFeeTotal
                    + summary.shippingFee;

                // ìš°ì¸¡ ìš”ì•½ UI ì—…ë°ì´íŠ¸
                $('#sum-products').textContent = fmt(summary.productsTotal);
                $('#sum-coupon').textContent = '-' + fmt(summary.couponDiscount);
                $('#sum-point').textContent = '-' + fmt(summary.pointDiscount);
                $('#sum-wrap').textContent = fmt(summary.wrapFeeTotal);
                $('#sum-shipping').textContent = fmt(summary.shippingFee);
                $('#sum-total').textContent = fmt(total);

                const infoEl = document.getElementById('free-shipping-info');
                if (infoEl) {
                    if (summary.shippingFee === 0) {
                        infoEl.textContent = 'ë¬´ë£Œë°°ì†¡ ì ìš©ë¨ ğŸ‰';
                    } else {
                        infoEl.textContent =
                            policy.freeStandardAmount.toLocaleString() + 'ì› ì´ìƒ êµ¬ë§¤ ì‹œ ë¬´ë£Œë°°ì†¡';
                    }
                }

                // hidden ê°’ ë™ê¸°í™”
                const priceHidden = document.getElementById('price');
                if (priceHidden) priceHidden.value = total;

                const pointUsedHidden = document.getElementById('pointUsed');
                if (pointUsedHidden) pointUsedHidden.value = summary.pointDiscount;

                return total;
            };

            //  ì£¼ë¬¸ì/ìˆ˜ë ¹ì¸, ì£¼ì†Œ ê´€ë ¨ ë¡œì§

            // ì£¼ë¬¸ì ì •ë³´ = ìˆ˜ë ¹ì¸ ì •ë³´ ë³µì‚¬
            const sameCheck = $('#sameAsOrderer');
            if (sameCheck) {
                sameCheck.addEventListener('change', e => {
                    const on = e.target.checked;
                    $('#receiverName').value = on ? ($('#ordererName').value || '') : '';
                    $('#receiverPhone').value = on ? ($('#ordererPhone').value || '') : '';
                });
            }

            // ë°°ì†¡ì¼ ê¸°ë³¸ê°’ = ì˜¤ëŠ˜ + 3ì¼
            const deliveryDate = $('#deliveryDate');
            if (deliveryDate) {
                const today = new Date();
                today.setDate(today.getDate() + 3);
                deliveryDate.min = today.toISOString().split('T')[0];
                if (!deliveryDate.value) {
                    deliveryDate.value = deliveryDate.min;
                }
            }

            // ì €ì¥ëœ ë°°ì†¡ì§€ ì„ íƒ ì‹œ ìë™ ì±„ìš°ê¸°
            const addressSelect = document.getElementById("addressSelect");
            if (addressSelect) {
                addressSelect.addEventListener("change", (e) => {
                    const selected = e.target.selectedOptions[0];
                    if (!selected) return;

                    const postcode = selected.dataset.postcode || "";
                    const road = selected.dataset.road || "";
                    const detail = selected.dataset.detail || "";

                    document.getElementById("postcode").value = postcode;
                    document.getElementById("roadAddress").value = road;
                    document.getElementById("detailAddress").value = detail;

                    console.log("[ë°°ì†¡ì§€ ì„ íƒ]", { postcode, road, detail });
                });
            }

            // ì£¼ì†Œ ê²€ìƒ‰ API
            window.findAddress = function () {
                new daum.Postcode({
                    oncomplete: function (data) {
                        const roadAddr = data.roadAddress;
                        const jibunAddr = data.jibunAddress;
                        const zonecode = data.zonecode;
                        const buildingName = data.buildingName || '';

                        document.getElementById("postcode").value = zonecode;
                        document.getElementById("roadAddress").value = roadAddr;

                        const detailInput = document.getElementById("detailAddress");
                        if (detailInput) {
                            detailInput.value = "";
                            detailInput.focus();
                        }

                        const select = document.getElementById("addressSelect");
                        if (select) {
                            select.value = "";
                        }

                        console.log("ì„ íƒëœ ì£¼ì†Œ:", {
                            ë„ë¡œëª…ì£¼ì†Œ: roadAddr,
                            ì§€ë²ˆì£¼ì†Œ: jibunAddr,
                            ê±´ë¬¼ëª…: buildingName,
                            ìš°í¸ë²ˆí˜¸: zonecode
                        });
                    }
                }).open();
            };

            //   ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¿ í°/í¬ì¸íŠ¸/í¬ì¥)

            // ì¿ í° ë³€ê²½ ì‹œ
            $$('.coupon-select').forEach(sel => {
                sel.addEventListener('change', recalc);
            });

            // í¬ì¸íŠ¸ ì…ë ¥ ì‹œ
            $$('.point-input').forEach(input => {
                input.addEventListener('input', () => {
                    input.value = String(num(input.value)); // ìˆ«ìë§Œ ìœ ì§€
                    recalc();
                });
            });

            // í¬ì¥ì§€ ì„ íƒ ì‹œ
            $$('.wrap-radio').forEach(r => {
                r.addEventListener('change', recalc);
            });

            // í¬ì¸íŠ¸ ìµœëŒ€ ë²„íŠ¼
            window.useMaxPoint = (btn) => {
                const input = btn.closest('.input-group')?.querySelector('.point-input');
                if (!input) return;

                const max = getPointMaxTotal();
                const others = $$('.point-input')
                    .filter(i => i !== input)
                    .map(i => num(i.value))
                    .reduce((a, b) => a + b, 0);

                const remain = Math.max(0, max - others);
                input.value = remain;
                recalc();
            };

            // ê³„ì‚°
            recalc();

            //   ì£¼ë¬¸ submit (paymentType ë¶„ê¸°)
            const checkoutForm = document.getElementById("checkoutForm");
            const paymentModal = document.getElementById("paymentModal");
            const cancelModalBtn = document.getElementById("cancelModalBtn");

            checkoutForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const total = recalc();

                // ì´ ê²°ì œê¸ˆì•¡ 0ì› â†’ í¬ì¸íŠ¸ ì „ì•¡ ê²°ì œ
                if (total === 0) {
                    checkoutForm.action = "/payments/point";
                    checkoutForm.method = "post";
                    checkoutForm.submit();
                    return;
                }

                // TOSS ê²°ì œ â†’ ëª¨ë‹¬ ì—´ê¸°
                resetTossModal();
                paymentModal.style.display = "block";
                initTossPayment();
            });

            if (cancelModalBtn) {
                cancelModalBtn.onclick = () => paymentModal.style.display = "none";
                resetTossModal();
            }

            function resetTossModal() {
                // toss ìœ„ì ¯ DOM ì´ˆê¸°í™”
                $("#payment-method").innerHTML = "";
                $("#agreement").innerHTML = "";
            }
        });

        // Toss ê²°ì œ ì‹œì‘
        async function initTossPayment() {
            const $ = document.querySelector.bind(document);

            const orderId = $('#orderNumber').value;
            const orderName = $('#orderName').value;
            const totalAmount = Number($('#price').value);
            const pointUsed = $('#pointUsed').value;

            const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
            const tossPayments = TossPayments(clientKey);

            const widgets = tossPayments.widgets({ customerKey: orderId });

            await widgets.setAmount({
                currency: "KRW",
                value: totalAmount
            });

            await widgets.renderPaymentMethods({
                selector: "#payment-method",
                variantKey: "DEFAULT"
            });

            await widgets.renderAgreement({
                selector: "#agreement",
                variantKey: "AGREEMENT"
            });

            $("#payButton").onclick = async function () {
                try{
                    await widgets.requestPayment({
                        orderId,
                        orderName,
                        // í¬ì¸íŠ¸ ì‚¬ìš©ëŸ‰ì„ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì½œë°±ì— ì „ë‹¬
                        successUrl: `${window.location.origin}/payments/success?pointUsed=${pointUsed}`,
                        failUrl: `${window.location.origin}/payments/fail`
                    });
                }catch (err) {

                    // í•„ìˆ˜ ì•½ê´€ ë™ì˜ ì•ˆ í•¨
                    if (err && err.code === "NEED_AGREEMENT" || String(err.message).includes("í•„ìˆ˜")) {
                        alert("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì•¼ ê²°ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }

                    // ê·¸ ì™¸ í† ìŠ¤ ì˜¤ë¥˜ ì¶œë ¥
                    console.error("ê²°ì œ ì˜¤ë¥˜:", err);
                    alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            };
        }
    </script>

</section>
</html>