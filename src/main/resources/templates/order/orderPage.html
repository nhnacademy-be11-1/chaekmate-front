<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{layout/layout :: html(~{::section})}">
<head>
    <meta charset="UTF-8">
</head>
<section>
    <style>
        /* ------- 공통 카드 스타일 (기존 유지) ------- */
        .cm-card {
            background: var(--light);
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: .25rem;
        }

        .cm-section-title {
            position: relative;
            display: inline-block;
            padding: .25rem .75rem;
            background: var(--secondary);
            color: var(--dark);
            text-transform: uppercase;
        }

        .cm-total-row {
            display: flex;
            justify-content: space-between;
            padding: .25rem 0;
        }

        .cm-total-row.cm-strong {
            border-top: 1px solid rgba(0, 0, 0, .1);
            margin-top: .5rem;
            padding-top: .75rem;
            font-weight: 600;
        }

        .cm-wrap-tile {
            border: 1px solid rgba(0, 0, 0, .08);
            border-radius: .25rem;
            padding: .5rem;
            cursor: pointer;
        }

        .cm-wrap-tile.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 211, 51, .25);
        }

        @keyframes cm-shine {
            0% {
                background-position: 200% 0
            }
            100% {
                background-position: -200% 0
            }
        }

        /* ------- sticky 결제 요약 ------- */
        @media (min-width: 992px) {
            #summary-area {
                position: sticky;
                top: 100px;
            }
        }
    </style>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-light mb-30">
                    <a class="breadcrumb-item text-dark" href="/">홈</a>
                    <a class="breadcrumb-item text-dark" href="/shop">서점</a>
                    <span class="breadcrumb-item active">주문서</span>
                </nav>
            </div>
        </div>
    </div>

    <form id="checkoutForm" class="container-fluid" th:action="@{/payments}" method="post">
        <div class="row px-xl-5">
            <!-- 좌측: 주문 상품 / 배송정보 -->
            <div class="col-lg-8">
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">주문 상품</span></h5>
                <div class="cm-card p-3 mb-4">
                    <div class="table-responsive">
                        <table class="table table-borderless align-middle mb-0">
                            <thead>
                            <tr class="text-dark">
                                <th style="width:64px">표지</th>
                                <th>상품명</th>
                                <th class="text-right">가격</th>
                                <th class="text-center">수량</th>
                                <th class="text-right">소계</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item,idx : ${orderItems}">
                                <td><img th:src="@{${item.thumbnailUrl}}" class="img-fluid rounded"
                                         style="max-width:48px;"></td>
                                <td>
                                    <div class="font-weight-bold" th:text="${item.name}">책 제목</div>
                                    <small class="text-muted d-block" th:text="${item.author}">저자</small>

                                    <!-- 쿠폰 -->
                                    <div class="mt-2">
                                        <label class="mb-1 d-block">쿠폰 적용</label>
                                        <select class="custom-select coupon-select" th:data-price="${item.price}">
                                            <option value="">선택 안함</option>
                                            <option value="3000">3,000원 할인 쿠폰</option>
                                            <option value="5000">5,000원 할인 쿠폰</option>
                                        </select>
                                    </div>

                                    <!-- 포인트 -->
                                    <div class="mt-2">
                                        <label class="mb-1">포인트 사용</label>
                                        <div class="input-group">
                                            <input type="number" min="0" class="form-control point-input"
                                                   placeholder="사용 포인트 입력" th:data-max="${member.remainingPoints}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                        onclick="useMaxPoint(this)">최대
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted">보유 포인트: <b
                                                th:text="${member.remainingPoints}">12000</b>P</small>
                                    </div>

                                    <!-- 포장지 -->
                                    <div class="mt-3">
                                        <label class="mb-1 d-block">포장지 선택</label>
                                        <div class="d-flex">
                                            <label class="cm-wrap-tile mr-2">
                                                <input type="radio" name="wrap" value="0" class="sr-only wrap-radio">
                                                <span>기본 (무료)</span>
                                            </label>
                                            <label class="cm-wrap-tile">
                                                <input type="radio" name="wrap" value="1500" class="sr-only wrap-radio">
                                                <span>선물 포장 (+1,500원)</span>
                                            </label>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-right price" th:text="${item.price}">38000</td>
                                <td class="text-center qty" th:text="${item.quantity}">1</td>
                                <td class="text-right subtotal" th:text="${item.subtotal}">38000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 배송 정보 -->
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">배송 정보</span></h5>
                <div class="cm-card p-3 mb-5">
                    <div class="form-group">
                        <label>수령인 이름</label>
                        <input type="text" class="form-control" name="receiverName" placeholder="홍길동">
                    </div>
                    <div class="form-group">
                        <label>연락처</label>
                        <input type="text" class="form-control" name="receiverPhone" placeholder="010-1234-5678">
                    </div>
                    <div class="form-group">
                        <label>배송 요청사항</label>
                        <textarea class="form-control" name="request" rows="2" placeholder="예: 문 앞에 놓아주세요."></textarea>
                    </div>
                </div>
            </div>

            <!-- 우측: 결제 요약 -->
            <div class="col-lg-4">
                <h5 class="section-title text-uppercase mb-3"><span class="cm-section-title">결제 요약</span></h5>
                <div id="summary-area" class="cm-card p-3">
                    <div class="cm-total-row"><span>상품 합계</span><span id="sum-products">0원</span></div>
                    <div class="cm-total-row"><span>쿠폰 할인</span><span id="sum-coupon">-0원</span></div>
                    <div class="cm-total-row"><span>포인트 사용</span><span id="sum-point">-0원</span></div>
                    <div class="cm-total-row"><span>포장비</span><span id="sum-wrap">0원</span></div>
                    <div class="cm-total-row"><span>배송비</span><span id="sum-shipping">3,000원</span></div>
                    <div class="cm-total-row cm-strong">
                        <span>총 결제금액</span><span id="sum-total">0원</span>
                    </div>
                    <button type="submit" class="btn btn-block btn-primary font-weight-bold py-3 mt-3">결제하기</button>
                </div>
            </div>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const format = n => n.toLocaleString('ko-KR') + '원';
            const summary = {
                productsTotal: 0,
                couponDiscount: 0,
                pointDiscount: 0,
                wrapFeeTotal: 0,
                shippingFee: 3000
            };

            const updateSummary = () => {
                document.querySelectorAll('.subtotal').forEach(td => {
                    summary.productsTotal += parseInt(td.innerText || 0);
                });
                const total = summary.productsTotal - summary.couponDiscount - summary.pointDiscount + summary.wrapFeeTotal + summary.shippingFee;
                document.getElementById('sum-products').innerText = format(summary.productsTotal);
                document.getElementById('sum-coupon').innerText = '-' + format(summary.couponDiscount);
                document.getElementById('sum-point').innerText = '-' + format(summary.pointDiscount);
                document.getElementById('sum-wrap').innerText = format(summary.wrapFeeTotal);
                document.getElementById('sum-shipping').innerText = format(summary.shippingFee);
                document.getElementById('sum-total').innerText = format(total);
                summary.productsTotal = 0; // 초기화 (중복합 방지)
            };

            // 초기 렌더링
            updateSummary();

            // 쿠폰 선택 시
            document.querySelectorAll('.coupon-select').forEach(sel => {
                sel.addEventListener('change', e => {
                    const value = parseInt(e.target.value || 0);
                    summary.couponDiscount = value;
                    updateSummary();
                });
            });

            // 포인트 입력 시
            document.querySelectorAll('.point-input').forEach(input => {
                input.addEventListener('input', e => {
                    const value = parseInt(e.target.value || 0);
                    summary.pointDiscount = value;
                    updateSummary();
                });
            });

            // 포장지 클릭 시
            document.querySelectorAll('.wrap-radio').forEach(radio => {
                radio.addEventListener('change', e => {
                    summary.wrapFeeTotal = parseInt(e.target.value || 0);
                    updateSummary();
                });
            });
        });

        function useMaxPoint(btn) {
            const input = btn.closest('.input-group').querySelector('.point-input');
            const max = input.dataset.max || 0;
            input.value = max;
            input.dispatchEvent(new Event('input'));
        }
    </script>
</section>
</html>
